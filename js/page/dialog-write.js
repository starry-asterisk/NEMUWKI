/**
* Project: nemuwiki.com
* Version: 2.5.0 | product
* Author: @NEMUWIKI
* Date: 2025-04-16
* Description: personal wiki project for NEMU
*/

class asideDialogWrite extends asideBase{constructor(){super(),app.blockMode=!0;let e=new Model(Object.keys(FormContent),(function(e){if(!FormContent[e].text)return;let t=createElement("li").css({"font-size":"var(--font-size-regular)",cursor:"pointer"}).attrs({draggable:!0}).props({ondragstart(t){t.dataTransfer.setData("text",`$$nemuwiki$$-${e}`),article.ondragover=e=>{e.preventDefault()},article.ondrop=t=>{t.preventDefault();let a,o,n,l=999;for(let e of Array.from(article.querySelectorAll(".focusable")))a=e.getBoundingClientRect(),o=a.y+.5*a.height,Math.abs(o-t.clientY)>Math.abs(l-t.clientY)||(l=o,n=e);let r=app_article.createForm(e,void 0,void 0,!0);n?l<t.clientY?n.after(r):n.before(r):article.append(r),r.scrollIntoViewIfNeeded()}},ondragend(){article.ondrop=article.ondragover=null}});t.append(createElement("span").attrs({class:"tag icon"}).addClass(FormContent[e].icon).props({onclick(){article.append(app_article.createForm(e,void 0,void 0,!0))}}),createElement("span").attrs({"data-type":e}).props({innerHTML:FormContent[e].text})),this.ul.append(t)}));aside.append(this.createBlockList("components","컴포넌트",e),createElement("button").props({innerHTML:"게시하기",onclick:submit}).addClass("f_button").addClass("submit_btn").css({"max-width":"23rem",width:"100%"}))}}class articleDialogWrite extends articleBase{constructor(e){super(),this.contentBase=ContentBase,this.formBase=FormContent;let t=this;if(!1===app.user)return app.blockMode=!1,void move(`401?message=${encodeURI(TEXTS.warn.login_neccesary)}&url=${location.href}`,!0);let a=new Model([],(function(e){this.wrap.append(ToolBase[e](createElement("span").addClass(e,"flex-horizontal"),t._focusedElement))}),(function(){emptyNode(this.wrap)})),o=[this.createForm("toolbar","toolbar",a),this.createForm("bottomtoolbar"),this.createForm("main_header","main_header")];a.bind(this.components.toolbar),a.proceed();let n=e.get("dialog");n?(document.title=`${TEXTS.sitename} :: 문서 편집 - 로딩중`,(async()=>{let e=await firebase.dialog.selectOne(n),t=e.data();if(this.BeforeData={id:e.id,...t},!t)return app.blockMode=!1,move(`404?message=${encodeURI("존재하지 않는 문서입니다.")}&url=${location.href}`,!0);if(t.deleted)return app.blockMode=!1,move(`404?message=${encodeURI("삭제된 문서입니다.")}&url=${location.href}`,!0);document.title=`${TEXTS.sitename} :: 문서 편집 - ${t.title}`,this.components.main_header.wrap.setData(t.title);for(let e of t.contents){let t=e.value,a=this.createForm(e.type,void 0,t,!0);if("textbox"===e.type)for(let e of Array.from(a.querySelectorAll('[style*="font-size"]')))e.style.fontSize.endsWith("rem")&&e.css({"font-size":10*parseFloat(e.style.fontSize)+"px"});o.push(a)}article.append.apply(article,o)})()):(document.title=`${TEXTS.sitename} :: 새로운 문서`,article.append.apply(article,o))}createForm(e,t=randomId(),a,o=!1){let n=createElement("div").attrs({class:`flex-horizontal form ${e}`,id:t,tabIndex:this.tabIndex++,"data-type":e});if(o){let e=createElement("div").addClass("form__move","flex-vertical"),a=createElement("button").addClass("form__move__up").props({onclick(){n.prev(".focusable")?.before(n)}}),o=createElement("button").addClass("form__move__down").props({onclick(){n.next(".focusable")?.after(n)}}),l=createElement("button").addClass("form__drag"),r=createElement("button").addClass("form__del");n.addClass("focusable").onfocus=n.onfocusin=n.onclick=()=>this.focusedElement=n,r.onclick=()=>{n.remove(),delete this.components[t],delete this.data[t],this.focusedElement==n&&(this.focusedElement=null)},l.ontouchstart=l.onmousedown=e=>{e.preventDefault(),n.addClass("dragging"),n.focus();let t,a=n.getBoundingClientRect(),o=e.touches?e.touches[0]:e,l=createElement("span").addClass("form__placeholder");window.ontouchmove=window.onmousemove=e=>{e.preventDefault(),t=e.touches?e.touches[0]:e,n.css({transform:`translate(${parseInt(t.pageX-o.pageX)}px, ${parseInt(t.pageY-o.pageY)}px)`});let r,i,s=a.y+.5*a.height;for(let e of Array.from(article.querySelectorAll(".focusable")).filter((e=>e!=n)))a=e.getBoundingClientRect(),r=a.y+.5*a.height,Math.abs(r-t.clientY)>Math.abs(s-t.clientY)||(s=r,i=e);i&&(s<t.clientY?i.after(l):i.before(l))},window.onmouseleave=window.onmouseup=window.ontouchend=()=>{window.onmouseleave=window.onmouseup=window.ontouchend=window.onmousemove=window.ontouchmove=null,n.style.removeProperty("transform"),n.removeClass("dragging"),t&&(l.replaceWith(n),n.focus())}},e.append(a,l,o),n.append(e,r)}return this.components[t]={wrap:n},this.data[t]=a,this.formBase[e]&&this.formBase[e].initialize.call(this,t,n,a),n}destroy(){}}const FormContent={toolbar:{initialize(e,t,a){t.addClass("flex-horizontal")}},bottomtoolbar:{__initialize(e,t,a){let o=createElement("button").attrs({class:"icon icon-plus preventable"}),n=createElement("button").props({innerHTML:"미리보기",onclick:preview}).attrs({class:"previewBtn"}),l=createElement("button").props({innerHTML:"게시",onclick:submit}).addClass("preventable").addClass("submit_btn"),r=[];for(let e in this.formBase)this.formBase[e].text&&r.push({text:this.formBase[e].text,value:e});let i=createSelect(r,0).addClass("preventable");i.submit=()=>o.onmousedown(),o.onmousedown=e=>{e&&e.preventDefault(),s(i.dataset.value)},t.addClass("flex-horizontal").append(i,o,n,l);let s=e=>{let t=this.createForm(e,void 0,void 0,!0);this.focusedElement?this.focusedElement.after(t):article.append(t),t.scrollIntoViewIfNeeded()}},initialize(e,t,a){let o=createElement("button").props({innerHTML:"미리보기",onclick:preview}).attrs({class:"previewBtn"}),n=createElement("button").props({innerHTML:"게시",onclick:submit}).addClass("preventable").addClass("submit_btn");for(let e in this.formBase){let{text:a,icon:o}=this.formBase[e];a&&t.append(createElement("button").attrs({class:`icon ${o} preventable`,title:a}).props({onclick(){l(e)}}))}t.addClass("flex-horizontal").append(o,n);let l=e=>{let t=this.createForm(e,void 0,void 0,!0);this.focusedElement?this.focusedElement.after(t):article.append(t),t.scrollIntoViewIfNeeded()}}},main_header:{initialize(e,t,a){let o=createElement("div").addClass("form__inputs").css({"grid-template-columns":"1fr"}),n=createElement("input").attrs({type:"text",placeholder:"예시 ) 캐릭터 A",name:"text",id:randomId()}).css({"font-size":"var(--font-size-large)"}),l=createElement("label").attrs({for:n.id}).props({innerHTML:"문서 제목"}).css({"font-size":"var(--font-size-xlarge)","font-weight":"bold"});o.append(l,n),t.append(o),t.getData=()=>n.value,t.setData=e=>n.value=e}},textbox:{text:"텍스트박스",icon:"icon-format-textbox",initialize(e,t,a){let o=createElement("div").attrs({contenteditable:!0,placeholder:"텍스트박스.\n                여기에 텍스트를 입력하세요.",class:"form__textbox"}).props({innerHTML:a||"",onpaste(e){e.preventDefault(),document.execCommand("inserttext",!1,e.clipboardData.getData("text/plain"))},ondrop(e){const t=document.createTextNode(e.dataTransfer.getData("text/plain"));if(t.textContent.startsWith("$$nemuwiki$$"))return;let a;if(e.preventDefault(),"caretRangeFromPoint"in document)a=document.caretRangeFromPoint(e.clientX,e.clientY);else{if(!("caretPositionFromPoint"in document))return;a=document.caretPositionFromPoint(e.clientX,e.clientY)}a.insertNode(t),a.setStart(t,0),a.setEnd(t,t.length);const o=window.getSelection();o.removeAllRanges(),o.addRange(a),this.oninput()},onblur(){let e=window.getSelection();lastSelection={anchorNode:e.anchorNode,anchorOffset:e.anchorOffset,focusNode:e.focusNode,focusOffset:e.focusOffset}},oninput(){this.querySelectorAll('[style^="font-size: var(--"]').forEach((e=>e.style.removeProperty("font-size"))),this.querySelectorAll('[style^="background-color: var(--"]').forEach((e=>e.style.removeProperty("background-color"))),this.toggleClass("empty",this.textContent.trim().length<1)}});o.toggleClass("empty",o.textContent.trim().length<1),t.append(o),t.getData=()=>o.innerHTML},buttons:["foreColor","backColor","bold","italic","strikeThrough","underline","fontSize","justifyLeft","justifyCenter","justifyRight","formatBlock","createLink","insertAnno","insertImage","unlink","removeFormat","selectAll","undo","redo"]},image:{text:"사진",icon:"icon-image",initialize(e,t,a={}){"string"==typeof a&&(a={src:a});let o=createElement("div").addClass("form__image"),n=createElement("div").addClass("form__image__wrap","flex-horizontal"),l=new Image,r=createElement("div").addClass("flex-vertical"),i=a.isThumb||!1,s=a.hidden||!1,c=a.align||"left",d=createElement("p"),p=createElement("input").attrs({type:"checkbox",label:"대표 이미지 설정"}).addClass("s_chk").props({onchange(){n.toggleClass("main",i=this.checked)}}),m=createElement("p"),u=createElement("input").attrs({type:"checkbox",label:"이미지 감추기"}).addClass("s_chk").props({onchange(){s=this.checked}}),f=createElement("input").attrs({type:"number",min:10,step:1}),h=createElement("input").attrs({type:"number",min:10,step:1}),g=createElement("p").addClass("input_l");l.onload=function(){let e=l.naturalWidth/l.naturalHeight;f.value=a.width||l.naturalWidth,h.value=parseInt(f.value/e),f.oninput=()=>{h.value=parseInt(f.value/e)},h.oninput=()=>{f.value=parseInt(h.value*e)}},g.append(document.createTextNode("W"),f,document.createTextNode("H"),h),d.append(p),m.append(u),r.append(g,d,m);let b=createElement("button").addClass("f_button").props({innerHTML:"이미지 선택"}),v="",x=e=>{v=e,l.src=e.startsWith("http")?imgurThumb(e,"m"):firebase.storage.getStaticUrl(e)};b.onclick=()=>{modal("addImg",x)},a.src&&x(a.src),i&&(p.checked=!0),s&&(u.checked=!0),a.align&&(l.dataset.align=c),n.append(l,r),o.append(b,n),t.append(o),t.getData=()=>({width:f.value||10,src:v,isThumb:i,hidden:s,align:l.dataset.align||"left"})},buttons:["imageToLeft","imageToCenter","imageToRight"]},dialog:{text:"대화",icon:"icon-forum",initialize(e,t,a={align:"left",image:{width:100},html:""}){let o=createElement("div").addClass("form__dialog"),n=createElement("div").addClass("form__dialog__image"),l=new Image,r=createElement("div").addClass("flex-vertical"),i=a.align||"left",s=createElement("input").attrs({type:"number",min:10,step:1}),c=createElement("input").attrs({type:"number",min:10,step:1}),d=createElement("p").addClass("input_l"),p=createElement("input").attrs({type:"text",maxlength:24}).addClass("input2"),m=createElement("p").addClass("input_l");l.onload=function(){let e=l.naturalWidth/l.naturalHeight;s.value=a.image.width||l.naturalWidth,c.value=parseInt(s.value/e),s.oninput=()=>{c.value=parseInt(s.value/e)},c.oninput=()=>{s.value=parseInt(c.value*e)}},m.append(document.createTextNode("이름"),p),d.append(document.createTextNode("W"),s,document.createTextNode("H"),c),r.append(m,d);let u=createElement("button").addClass("f_button").props({innerHTML:"이미지 선택"}),f="",h=e=>{f=e,l.src=e.startsWith("http")?imgurThumb(e,"m"):firebase.storage.getStaticUrl(e)};u.onclick=()=>{modal("addImg",h)},a.image.src&&h(a.image.src),a.align&&(o.dataset.align=i),a.name&&(p.value=a.name),n.append(u,l,r),o.append(n);let g=createElement("div").attrs({contenteditable:!0,placeholder:"텍스트박스.\n                여기에 텍스트를 입력하세요.",class:"form__dialog__textbox"}).props({innerHTML:a.html||"",onpaste(e){e.preventDefault(),document.execCommand("inserttext",!1,e.clipboardData.getData("text/plain"))},ondrop(e){const t=document.createTextNode(e.dataTransfer.getData("text/plain"));if(t.textContent.startsWith("$$nemuwiki$$"))return;let a;if(e.preventDefault(),"caretRangeFromPoint"in document)a=document.caretRangeFromPoint(e.clientX,e.clientY);else{if(!("caretPositionFromPoint"in document))return;a=document.caretPositionFromPoint(e.clientX,e.clientY)}a.insertNode(t),a.setStart(t,0),a.setEnd(t,t.length);const o=window.getSelection();o.removeAllRanges(),o.addRange(a),this.oninput()},onblur(){let e=window.getSelection();lastSelection={anchorNode:e.anchorNode,anchorOffset:e.anchorOffset,focusNode:e.focusNode,focusOffset:e.focusOffset}},oninput(){this.querySelectorAll('[style^="font-size: var(--"]').forEach((e=>e.style.removeProperty("font-size"))),this.querySelectorAll('[style^="background-color: var(--"]').forEach((e=>e.style.removeProperty("background-color"))),this.toggleClass("empty",this.textContent.trim().length<1)}});g.toggleClass("empty",g.textContent.trim().length<1),o.append(g),t.append(o),t.getData=()=>({align:o.dataset.align||"left",image:{width:s.value||100,src:f},name:p.value,html:g.innerHTML})},buttons:["dialogToLeft","dialogToRight","foreColor","backColor","bold","italic","strikeThrough","underline","fontSize","justifyLeft","justifyCenter","justifyRight","formatBlock","createLink","insertAnno","insertImage","unlink","removeFormat","selectAll","undo","redo"]}},ToolBase={foreColor:(e,t)=>(e.attrs({title:"글씨에 형광펜 효과를 줍니다."}),e.append(createElement("button").attrs({class:"icon icon-format-color-text"}).props({onclick:()=>execModal("foreColor","colorPicker",(a=>(t.matches("n-table")&&getCells(t).forEach((e=>{if(""==e.innerHTML)e.innerHTML='<div style="color:'+a+'"> </div>';else for(let t of Array.from(e.childNodes))cellCss(e,t,{color:a})})),e.style.setProperty("--input-color",a),e.dataset.foreColor=a,a)),e.dataset.foreColor)})),e),backColor:(e,t)=>(e.attrs({title:"글씨에 형광펜 효과를 줍니다."}),e.append(createElement("button").attrs({class:"icon icon-format-color-highlight"}).props({onclick:()=>execModal("backColor","colorPicker",(a=>(t.matches("n-table")&&getCells(t).forEach((e=>{if(""==e.innerHTML)e.innerHTML='<span style="background-color:'+a+'"> </span>';else for(let t of Array.from(e.childNodes))cellCss(e,t,{"background-color":a},"span")})),e.style.setProperty("--input-color",a),e.dataset.backColor=a,a)),e.dataset.backColor)})),e),bold:(e,t)=>(e.attrs({title:"굵은 글씨 효과"}),e.append(createElement("button").attrs({class:"icon icon-format-bold"}).props({onclick:execBuildVal("bold",void 0,(()=>{t.matches("n-table")&&getCells(t).forEach((e=>{if(""==e.innerHTML)e.innerHTML="<b> </b>";else for(let t of Array.from(e.childNodes))cellCss(e,t,{},"b")}))}))})),e),italic:(e,t)=>(e.attrs({title:"기울임 꼴"}),e.append(createElement("button").attrs({class:"icon icon-format-italic"}).props({onclick:execBuildVal("italic",void 0,(()=>{t.matches("n-table")&&getCells(t).forEach((e=>{if(""==e.innerHTML)e.innerHTML="<i> </i>";else for(let t of Array.from(e.childNodes))cellCss(e,t,{},"i")}))}))})),e),strikeThrough:(e,t)=>(e.attrs({title:"취소선 효과"}),e.append(createElement("button").attrs({class:"icon icon-format-strikethrough"}).props({onclick:execBuildVal("strikeThrough",void 0,(()=>{t.matches("n-table")&&getCells(t).forEach((e=>{if(""==e.innerHTML)e.innerHTML="<s> </s>";else for(let t of Array.from(e.childNodes))cellCss(e,t,{},"s")}))}))})),e),underline:(e,t)=>(e.attrs({title:"밑줄 효과"}),e.append(createElement("button").attrs({class:"icon icon-format-underline"}).props({onclick:execBuildVal("underline",void 0,(()=>{t.matches("n-table")&&getCells(t).forEach((e=>{if(""==e.innerHTML)e.innerHTML="<u> </u>";else for(let t of Array.from(e.childNodes))cellCss(e,t,{},"u")}))}))})),e),fontSize(e,t){e.addClass("group").attrs({title:"폰트 사이즈를 지정합니다. 기본값은 17px입니다."});let a=createElement("button").attrs({class:"icon icon-plus"}).props({onclick(){o.value=Number(o.value)+1,o.dispatchEvent(new Event("change"))}}),o=createElement("input").props({value:17,onchange(e){if(t.matches("n-table"))getCells(t).forEach((e=>{if(""==e.innerHTML)e.innerHTML='<span style="font-size:'+o.value+'px;"> </span>';else for(let t of Array.from(e.childNodes))cellCss(e,t,{"font-size":`${o.value}px`},"span")}));else{if(null!=e&&"anchorNode"in lastSelection){let e=window.getSelection(),{anchorNode:t,anchorOffset:a,focusNode:o,focusOffset:n}=lastSelection,l=document.createRange();l.setStart(t,a),l.setEnd(o,n),e.removeAllRanges(),e.addRange(l)}document.execCommand("styleWithCSS",0,!0),document.execCommand("fontSize",!1,"7");for(let e of article.querySelectorAll('[style*="xxx-large"]'))e.style.fontSize=`${o.value}px`||"17px"}}}).attrs({type:"number",min:12,step:1}),n=createElement("button").attrs({class:"icon icon-minus"}).props({onclick(){o.value=Number(o.value)-1,o.dispatchEvent(new Event("change"))}});return e.append(a,o,n),e},justifyLeft:(e,t)=>(e.attrs({title:"좌측 정렬"}),e.append(createElement("button").attrs({class:"icon icon-format-align-left"}).props({onclick:execBuildVal("justifyLeft")})),e),justifyCenter:(e,t)=>(e.attrs({title:"가운데 정렬"}),e.append(createElement("button").attrs({class:"icon icon-format-align-center"}).props({onclick:execBuildVal("justifyCenter")})),e),justifyRight:(e,t)=>(e.attrs({title:"우측 정렬"}),e.append(createElement("button").attrs({class:"icon icon-format-align-right"}).props({onclick:execBuildVal("justifyRight")})),e),formatBlock:(e,t)=>(e.attrs({title:"인용 하기"}),e.append(createElement("button").attrs({class:"icon icon-format-quote-close"}).props({onclick:execBuildVal("formatBlock","<blockquote>")})),e),createLink:(e,t)=>(e.attrs({title:"링크 생성"}),e.append(createElement("button").attrs({class:"icon icon-link-variant"}).props({onclick:execBuildPrompt("createLink","생성할 링크를 입력해 주세요.",(e=>e.startsWith("http")?e:"http://"+e))})),e),insertAnno:(e,t)=>(e.attrs({title:"주석 삽입"}),e.append(createElement("button").attrs({class:"icon icon-code-brackets"}).props({onclick:()=>execModal("insertText","addAnno",((e,t)=>`[*${e||"주석"} ${t||"텍스트를 입력하세요."}]`))})),e),insertImage:(e,t)=>(e.attrs({title:"링크 기반 이미지 삽입"}),e.append(createElement("button").attrs({class:"icon icon-image-plus"}).props({onclick:()=>execModal("insertImage","addImg",(e=>e.startsWith("http")?e:"http://"+e))})),e),unlink:(e,t)=>(e.attrs({title:"링크 삭제"}),e.append(createElement("button").attrs({class:"icon icon-link-variant-off"}).props({onclick:execBuildVal("unlink")})),e),removeFormat:(e,t)=>(e.attrs({title:"서식 지우기"}),e.append(createElement("button").attrs({class:"icon icon-format-clear"}).props({onclick:execBuildVal("removeFormat",void 0,(()=>{t.matches("n-table")&&getCells(t).forEach((e=>e.innerHTML=e.innerText))}))})),e),selectAll:(e,t)=>(e.attrs({title:"전체 선택하기"}),e.append(createElement("button").attrs({class:"icon icon-select-all"}).props({onclick:execBuildVal("selectAll")})),e),undo:(e,t)=>(e.attrs({title:"되돌리기"}),e.append(createElement("button").attrs({class:"icon icon-undo"}).props({onclick:execBuildVal("undo")})),e),redo:(e,t)=>(e.attrs({title:"다시하기"}),e.append(createElement("button").attrs({class:"icon icon-redo"}).props({onclick:execBuildVal("redo")})),e),imageToLeft(e,t){let a=t.querySelector("img");return e.attrs({title:"좌측 정렬"}),e.append(createElement("button").attrs({class:"icon icon-format-align-left"}).props({onclick:()=>a.dataset.align="left"})),e},imageToCenter(e,t){let a=t.querySelector("img");return e.attrs({title:"가운데 정렬"}),e.append(createElement("button").attrs({class:"icon icon-format-align-center"}).props({onclick:()=>a.dataset.align="center"})),e},imageToRight(e,t){let a=t.querySelector("img");return e.attrs({title:"우측 정렬"}),e.append(createElement("button").attrs({class:"icon icon-format-align-right"}).props({onclick:()=>a.dataset.align="right"})),e},dialogToLeft(e,t){let a=t.querySelector(".form__dialog");return e.attrs({title:"좌측 정렬"}),e.append(createElement("button").attrs({class:"icon icon-format-align-left"}).props({onclick:()=>a.dataset.align="left"})),e},dialogToRight(e,t){let a=t.querySelector(".form__dialog");return e.attrs({title:"우측 정렬"}),e.append(createElement("button").attrs({class:"icon icon-format-align-right"}).props({onclick:()=>a.dataset.align="right"})),e}};function preview(){document.body.addClass("preview-mode");let e=[app_article.createContent("zoom")],t=[],a=0,o=1,n="",l=[];this.onclick=()=>{this.onclick=preview;for(let t of e)t.remove();article.style.removeProperty("zoom"),document.body.removeClass("preview-mode")};for(let r of article.children){if(!r.getData)continue;let i,s="main_header"==r.dataset.type?{text:r.getData()}:r.getData(),c=app_article.createContent(r.dataset.type,void 0,s);switch(r.dataset.type){case"title":if(i={content:c,title:c.innerHTML},o<s.depth)n+=`${a}.`,l.push({depth:++o,prefix:n,index_str:n+"1.",index:a=1,...i});else if(o==s.depth)l.push({depth:o,prefix:n,index:++a,index_str:n+`${a}.`,...i});else{let e=l.findLast((e=>e.depth==s.depth));l.push({depth:o=s.depth,prefix:n=e.prefix,index:a=e.index+1,index_str:n+`${a}.`,...i})}break;case"summury":t.push(c);break;case"textbox":for(let e of Array.from(c.querySelectorAll('[style*="font-size"]')))e.style.fontSize.endsWith("rem")&&e.css({"font-size":10*parseFloat(e.style.fontSize)+"px"})}e.push(c)}t.length>0&&l.forEach((e=>{e.content.prepend(createElement("a").props({innerHTML:`${e.index_str} `,id:e.index_str.split(".").join("_"),onclick(e){e.preventDefault(),history.pushState({},"","#summury"),t[0].scrollIntoViewIfNeeded()}}).attrs({href:"#summury"}))}));for(let e of t)e.append.apply(e,l.map((e=>createElement("a").attrs({href:`#_${e.index_str.split(".").join("_")}`}).props({innerHTML:`${e.index_str} <span>${e.title}</span>`,onclick(t){t.preventDefault(),history.pushState({},"",`#_${e.index_str.split(".").join("_")}`),e.content.scrollIntoViewIfNeeded()}}).css({"margin-left":1.5*e.depth+"rem"}))));if(html_annotation.length>0){let t=createElement("div").attrs({class:"content annotation"});t.innerHTML=html_annotation,html_annotation="",e.push(t)}article.append.apply(article,e)}function execBuildVal(e,t,a){return function(){document.execCommand("styleWithCSS",0,!0),document.execCommand(e,!1,t||""),a&&a()}}function execBuildPrompt(e,t,a=e=>e){return function(){var o=Notify.prompt(t)||"";document.execCommand("styleWithCSS",0,!0),document.execCommand(e,!1,a(o))}}function execModal(e,t,a=e=>e,o){return modal(t,((t,o,n)=>{if("anchorNode"in lastSelection){let e=window.getSelection(),{anchorNode:t,anchorOffset:a,focusNode:o,focusOffset:n}=lastSelection,l=document.createRange();l.setStart(t,a),l.setEnd(o,n),e.removeAllRanges(),e.addRange(l)}document.execCommand("styleWithCSS",0,!0),document.execCommand(e,!1,a(t,o,n))}),o)}function cellCss(e,t,a,o="div"){if(3==t.nodeType){let n=createElement(o).css(a);n.innerHTML=t.textContent,console.log("1",e,"2",t,"3",n),e.replaceChild(n,t)}else{let e=t.tagName.toLowerCase()==o;e&&t.css(a);for(let n of Array.from(t.childNodes))3==n.nodeType&&e||cellCss(t,n,a,o)}}function getCells(e){let t=[],{first:a,last:o}=e.selection;if(!a||!o)return;let n,l=Number(a.dataset.row),r=Number(a.dataset.col),i=Number(o.dataset.row),s=Number(o.dataset.col);i<l&&(n=i,i=l,l=n),s<r&&(n=s,s=r,r=n);for(let a of Array.from(e._tbody.children)){let e=a.dataset.row,o=a.dataset.col;l>e||e>i||r>o||o>s||t.push(a)}return t}function logoutCallback(){move(`401?message=${encodeURI(TEXTS.warn.login_neccesary)}&url=${location.href}`,!0)}async function submit(){let{next:e}=firebase.dialogIndex.list(),t=await e(),a=0;for(let e of t){let t=e.data();a+=t.list.length}try{if(!Notify.confirm("작성한 내용을 업로드 하시겠습니까?"))return;let e={title:"[이 값이 보이면 개발자한테 알려주세요]",contents:[]};for(let t of article.children)if(t.getData)if("main_header"===t.dataset.type)e.title=t.getData();else e.contents.push({type:t.dataset.type,value:t.getData()});if(e.title.length>25)return Notify.alert("문서 명은 최대 25자 까지 가능합니다.");if(e.title.length<1)return Notify.alert("문서 명은 비워 둘 수 없습니다.");toggleSubmitMode(),app_article.BeforeData?(e.updated_timestamp=new Date,e.timestamp=new Date(1e3*app_article.BeforeData.timestamp.seconds),firebase.dialog.updateOne(app_article.BeforeData.id,e).then((async()=>{await makeKeyword(t[0],app_article.BeforeData.doc_index,app_article.BeforeData.id,e),app.blockMode=!1,move(`/dialog/?dialog=${app_article.BeforeData.id}`)})).catch(firebaseErrorHandler).finally((()=>toggleSubmitMode(!1)))):(e.updated_timestamp=new Date,e.timestamp=e.updated_timestamp,e.doc_index=a,firebase.dialog.insertOne(e).then((async o=>{if(null==o)return app.blockMode=!1,void move(`401?message=${encodeURI("권한이 없거나 자동 로그아웃 처리되었습니다.")}&url=${location.href}`,!0);await makeKeyword(t[0],a,o.id,e),app.blockMode=!1,move(`/dialog/?dialog=${o.id}`)})).catch((e=>{Notify.alert("ERROR::저장에 실패했습니다::"),dev.error(e)})).finally((()=>toggleSubmitMode(!1))))}catch(e){toggleSubmitMode(!1),Notify.alert(e)}}function toggleSubmitMode(e=!0){return document.querySelectorAll(".submit_btn").forEach((t=>t.disabled=e)),!0}async function makeKeyword(e,t,a,o){if(e)var n=await e.data();else n={list:[]},e={id:Math.floor(Math.random()*Math.pow(10,8)).toString(36)};n=e?await e.data():{list:[]};if(e=e||{id:Math.floor(Math.random()*Math.pow(10,8)).toString(36)},o.deleted)return n.list[t]={deleted:!0},await firebase.dialogIndex.set(e.id,n);let{title:l,timestamp:r,updated_timestamp:i,contents:s}=o,c=o.title.replace(/\s+/g,""),d=[];for(let e=0;e<c.length;e++){let t=c.length-e;for(let a=1;a<=t;a++)d.push(c.substr(e,a))}d=[...new Set(d)];let p,m,u={id:a,title:l,title_arr:d,timestamp:r};for(let e of s)switch(e.type){case"image":if(p&&!e.value.isThumb)break;p=e.value.src;break;case"table":if(p)break;if(e.value.cells)for(let t of e.value.cells)if(REGEX.image_for_exec.lastIndex=0,m=REGEX.image_for_exec.exec(t.value),m){p=m[1];break}break;case"textbox":if(p)break;if(REGEX.image_for_exec.lastIndex=0,m=REGEX.image_for_exec.exec(e.value),m){p=m[1];break}}p&&(u.thumbnail=p),i&&(u.updated_timestamp=i),n.list[t]=u,await firebase.dialogIndex.set(e.id,n)}const DialogContent={...ContentBase};export{asideDialogWrite as aside,articleDialogWrite as article,logoutCallback};