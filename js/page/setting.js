/**
* Project: nemuwiki.com
* Version: 2.3.2 | product
* Author: @NEMUWIKI
* Date: 2024-09-26
* Description: personal wiki project for NEMU
*/

class asideSetting extends asideBase{constructor(e){super();let t={},a=createElement("svg").attrs({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24"});a.css({width:"2rem",border:"1px solid var(--blue-gray-400)",fill:"var(--color-bg-light)",background:"var(--blue-gray-800)",padding:"0.2rem","border-radius":"var(--border-radius-small)","vertical-align":"middle","margin-right":"var(--spacing-small)"});let r=createElement("path").attrs({d:"M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.67 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"});a.append(r),aside.append(createElement("div").props({innerHTML:`${a.outerHTML} 설정`}).css({"text-align":"left",padding:"var(--spacing-medium)"}),this.createTab("default","일반",t),this.createTab("template","템플릿",t),this.createTab("resource","이미지 관리",t),this.createTab("deleted","삭제 문서 복구",t)),this.activate=(e=Object.keys(t)[0],a)=>{for(let e in t)t[e].disabled=!1;t[e]?.onclick(a)},app.user&&this.activate(e.get("menu")||void 0,!0)}createTab(e=randomId(),t="",a){let r=createElement("div").css({"text-align":"left"}),i=createElement("button").addClass("s_button").props({innerHTML:t||e,disabled:!0,onclick(t){for(let e in a)a[e].removeClass("on");this.toggleClass("on"),history.replaceState("",{},`?menu=${e}`),!0!==t&&app_article.showTab(e)}});return r.append(i),a[e]=i,r}}class articleSetting extends articleBase{constructor(e){super(),document.title=`${TEXTS.sitename} :: 설정`,loadStyle("setting"),!1!==app.user?app.user&&this.showTab(e.get("menu")||"default"):move(`401?message=${encodeURI(TEXTS.warn.login_neccesary)}&url=${location.href}`,!0)}destroy(){}showTab(e){let t=SettingTabs[e]||{};emptyNode(article),article.append(createElement("div").addClass("setting__title").props({innerHTML:t.title}),createElement("hr").css({width:"auto",height:"1px",background:"var(--blue-gray-100)"})),"function"==typeof t.init&&article.append(t.init(createElement("div").addClass("setting__wrap"),app.user))}}async function makeKeyword(e,t){if(t.deleted)return await firebase.search.unset(e);if("template"==t.board_name)return await firebase.search.unset(e);let{title:a,board_name:r,board_name_arr:i,category:n,timestamp:l,updated_timestamp:s,author:o,contents:d,hidden:m}=t,p=t.title.replace(/\s+/g,""),c=[];for(let e=0;e<p.length;e++){let t=p.length-e;for(let a=1;a<=t;a++)c.push(p.substr(e,a))}c=[...new Set(c)];let u,b,h={title:a,title_arr:c,board_name:r,board_name_arr:i,category:n,timestamp:l,author:o,hidden:m};for(let e of d)switch(e.type){case"image":if(u&&!e.value.isThumb)break;u=e.value.src;break;case"table":if(u)break;if(e.value.cells)for(let t of e.value.cells)if(REGEX.image.lastIndex=0,b=REGEX.image.exec(t.value),b){u=b[1];break}break;case"textbox":if(u)break;if(REGEX.image.lastIndex=0,b=REGEX.image.exec(e.value),b){u=b[1];break}}u&&(h.thumbnail=u),s&&(h.updated_timestamp=s),await firebase.search.set(e,h)}function logoutCallback(){move(`401?message=${encodeURI(TEXTS.warn.login_neccesary)}&url=${location.href}`,!0)}function loginCallback(){let e=new URLSearchParams(location.search);app_article.showTab(e.get("menu")||"default"),app_aside.activate(e.get("menu")||void 0,!0)}function parseField(e,t,a,r){let i=createElement("span").css({"max-width":e.width,"min-width":e.minWidth}),n="deleted-template"==r.board_name;switch(e.type){case"timestamp":i.attrs({title:"시각"}).props({innerHTML:new Date(1e3*t.seconds).toLocaleDateString()});break;case"button":let l=`cb${randomId()}`;for(;"function"==typeof cb[l];)l=`cb${randomId()}`;cb[l]=()=>{modifyRecord(a,e.name,r,n)},i.attrs({title:e.name}).addClass("setting__li__button",`icon-${e.name}`).attrs({onclick:`cb.${l}()`});break;case"board_name":i.attrs({title:r.board_name}).toggleClass("setting__li__tag",n).props({innerHTML:n?"템플릿":r.board_name});break;case"image":i.attrs({title:r.board_name}).props({innerHTML:`<img src="${imgurThumb(t,"m")}"/>`});break;case"size":i.attrs({title:"가로 × 세로"}).props({innerHTML:`${r.width} × ${r.height}`});break;case"volume":i.attrs({title:"용량"}).props({innerHTML:displayVolume(t)});break;default:i.attrs({title:t}).props({innerHTML:t})}return i.outerHTML}function displayVolume(e){e=Number(e);let t=0;for(;e>1023;)e/=1024,t++;return`${Math.floor(10*e)/10} ${["Byte","Kb","Mb","Gb"][t]}`}function parsseHeader(e){return createElement("li").addClass("header").props({innerHTML:e.map((e=>createElement("span").css({"max-width":e.width,"min-width":e.minWidth}).props({innerHTML:e.displayName||e.name}).outerHTML)).join("")})}window.cb={},window.modifyRecord=function(e,t,a,r){switch(t){case"open":move(`./index?post=${e}`);break;case"edit":move(`./form?post=${e}`);break;case"deletehash":if(!Notify.confirm("정말로 삭제 하시겠습니까?"))return;deleteImgurImg(e,a.deletehash,a.link).then((e=>{200===e.status?(Notify.alert("삭제가 완료 되었습니다."),app_article.showTab("resource")):Notify.alert("Imgur사이트 파일 삭제에 실패했습니다.")})).catch(firebaseErrorHandler);break;case"del":if(!Notify.confirm("정말로 삭제 하시겠습니까?"))return;firebase.post.deleteTemporary(e,void 0,!0).then((()=>{Notify.alert("삭제가 완료 되었습니다."),app_article.showTab("template")})).catch(firebaseErrorHandler);break;case"recover":if(!Notify.confirm("복구 하시겠습니까?"))return;firebase.post.recover(e,void 0,r).then((async()=>{r||await makeKeyword(e,a),Notify.alert("복구가 완료 되었습니다."),move(`./index?post=${e}`)})).catch(firebaseErrorHandler)}};const SettingTabs={default:{title:"일반",init(e,t){let a,r,i,n;(e=createElement("div").addClass("flex-vertical")).append(a=createElement("div").addClass("setting_default"),r=createElement("div").addClass("flex-vertical")),a.append((i=new Image).addClass("setting_default_banner"),(n=new Image).addClass("setting_default_avatar"));let l=createElement("div");l.append(createElement("button").addClass("s_button").css({"margin-inline":"auto"}).props({innerHTML:"프로필 사진 변경",onclick:e=>{e.preventDefault(),e.stopPropagation(),modal("addImg",(e=>n.src=e))}}),createElement("button").addClass("s_button").css({"margin-inline":"auto"}).props({innerHTML:"배너 사진 변경",onclick:e=>{e.preventDefault(),e.stopPropagation(),modal("addImg",(e=>i.src=e))}}));let s="#039AE5",o=createElement("div"),d=createElement("div").attrs({class:"b_input",placeholder:"테마색상"}).css({margin:"1rem auto 0",display:"inline-block"}).props({onclick:e=>{e.preventDefault(),e.stopPropagation(),modal("colorPicker",(e=>{s=e,m.value=e}),s)}}),m=createElement("input").attrs({placeholder:"",maxlength:7,readonly:!0});d.append(m),o.append(d,createElement("button").addClass("s_button").props({innerHTML:"초기화",onclick:e=>{e.preventDefault(),e.stopPropagation(),s="#039AE5",m.value=""}}));let p="#FAFAFA",c=createElement("div"),u=createElement("div").attrs({class:"b_input",placeholder:"보조 테마색상"}).css({margin:"1rem auto",display:"inline-block"}).props({onclick:e=>{e.preventDefault(),e.stopPropagation(),modal("colorPicker",(e=>{p=e,b.value=e}),p)}}),b=createElement("input").attrs({placeholder:"",maxlength:7,readonly:!0});u.append(b),c.append(u,createElement("button").addClass("s_button").props({innerHTML:"초기화",onclick:e=>{e.preventDefault(),e.stopPropagation(),p="#FAFAFA",b.value=""}}));let h=createElement("div");return h.append(createElement("button").addClass("s_button").css({"margin-inline":"auto"}).props({innerHTML:"취소",onclick:()=>{confirm("수정된 내용을 취소하시겠습니까?")&&app_article.showTab("default")}}),createElement("button").addClass("s_button").css({"margin-inline":"auto"}).props({innerHTML:"적용",onclick:()=>{if(!confirm("수정된 내용을 적용하시겠습니까?"))return;let e={};i.src&&(e.banner_url=i.src),n.src&&(e.photo_url=n.src),e.theme_color="#039AE5"==m.value?"":m.value,e.theme_sub_color="#FAFAFA"==b.value?"":b.value,console.log(e),firebase.auth.updateUser(t.uid,e).then((()=>{location.reload()}))}})),r.append(createElement("span").addClass("setting_default_email").props({innerHTML:t.email}),l,o,h),firebase.auth.getUser().then((e=>{let t=e.data();t.banner_url&&(i.src=t.banner_url),t.photo_url&&(n.src=t.photo_url),t.theme_color&&(m.value=t.theme_color),t.theme_sub_color&&(b.value=t.theme_sub_color),profile__email.innerHTML=t.email})).catch(firebaseErrorHandler),e}},template:{title:"템플릿 관리",init(e,t){let a,{next:r}=firebase.post.list({board_name:"template",author:t.uid},!0),i=[{displayName:"이름",name:"title",width:"auto",minWidth:"10rem",type:"text"},{displayName:"생성 날짜",name:"timestamp",width:"7rem",minWidth:"7rem",type:"timestamp"},{displayName:"열기",name:"open",width:"4rem",minWidth:"7rem",type:"button"},{displayName:"수정",name:"edit",width:"4rem",minWidth:"7rem",type:"button"},{displayName:"삭제",name:"del",width:"4rem",minWidth:"7rem",type:"button"}];e.append(parsseHeader(i));return(async()=>{a=await r(),a.map((t=>{let a=t.data();e.append(createElement("li").props({innerHTML:i.map((e=>parseField(e,a[e.name],t.id,a))).join("")}))}))})(),e}},categories:{title:"카테고리 관리",init(e,t){}},board:{title:"문서 분류 관리",init(e,t){}},resource:{title:"이미지 관리",init(e,t){let a=[{displayName:"이미지",name:"link",width:"auto",minWidth:"7rem",type:"image"},{displayName:"사이즈",name:"",width:"auto",minWidth:"10rem",type:"size"},{displayName:"크기",name:"size",width:"auto",minWidth:"10rem",type:"volume"},{displayName:"삭제",name:"deletehash",width:"6rem",minWidth:"6rem",type:"button"}];return e.append(parsseHeader(a)),firebase.resources.all().then((t=>{for(let r of t.docs){let t=r.data();e.append(createElement("li").props({innerHTML:a.map((e=>parseField(e,t[e.name],r.id,t))).join("")}).css({height:"5rem"}))}})),e}},deleted:{title:"삭제된 문서 관리",init(e,t){let a,{next:r}=firebase.post.list({deleted:!0,author:t.uid},null,"equal"),i=[{displayName:"분류",name:"board_name",width:"7rem",minWidth:"7rem",type:"board_name"},{displayName:"이름",name:"title",width:"auto",minWidth:"10rem",type:"text"},{displayName:"생성 날짜",name:"timestamp",width:"7rem",minWidth:"7rem",type:"timestamp"},{displayName:"삭제 날짜",name:"deleted_timestamp",width:"7rem",minWidth:"7rem",type:"timestamp"},{displayName:"복구",name:"recover",width:"4rem",minWidth:"4rem",type:"button"}];e.append(parsseHeader(i));return(async()=>{a=await r(),a.map((t=>{let a=t.data();e.append(createElement("li").props({innerHTML:i.map((e=>parseField(e,a[e.name],t.id,a))).join("")}))}))})(),e}},delete_user:{title:"회원 탈퇴",init(e,t){}}};export{asideSetting as aside,articleSetting as article,logoutCallback,loginCallback};