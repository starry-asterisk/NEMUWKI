/**
* Project: nemuwiki.com
* Version: 2.5.1 | product
* Author: @NEMUWIKI
* Date: 2025-05-01
* Description: personal wiki project for NEMU
*/

class asideIndex extends asideBase{constructor(e){super(),aside.addClass("fold");let t=new URLSearchParams;t.set("field","board_name_arr"),t.set("operator","array-contains");let a=new Model(Options.get("board"),(function(e){let a=createElement("li");t.set("keyword",e.value),a.append(createElement("a").attrs({href:`./index?${t.toString()}`,class:"tag"}).props({innerHTML:e.path})),this.ul.append(a)}),(function(){emptyNode(this.ul)})),n=new Model(app.getVisited(),(function({visited_id:e,title:a,board_name:n}){let i=createElement("li");t.set("keyword",n),i.append(createElement("a").attrs({href:`./index?${t.toString()}`,class:"tag","data-board":n}).props({innerHTML:n}),createElement("a").attrs({href:`./index?post=${e}`}).props({innerHTML:a})),this.ul.append(i)}));aside.append(this.createBlock("B000",`<h1><a class="logo s_button" href="./">${TEXTS.sitename}</a></h1>`),this.createSearch("search",e),this.createBlockList("Visited",TEXTS.recent_document,n),this.createBlockList("Board",TEXTS.document_cate,a),this.createBlock("btn_upload",`<button class="s_button" onclick="move('form')">${TEXTS.upload}</button><button class="s_button" onclick=" move('profile')">${TEXTS.mypage}</button>`),this.createBlock("btn_login",`<button class="s_button" onclick="move('login')">${TEXTS.form.login}</button>`)),this.components.Board.ul.addClass("type2")}createSearch(e,t){let a=createElement("div").addClass("f_block","flex-horizontal").css({marginBottom:"var(--spacing-large)"}).props({id:`${e}_wrap`}),n=createElement("button").attrs({class:"menu_fold icon"}).props({onclick(){aside.toggleClass("fold")}}),i=this.createInput(e).addClass("icon"),r=createElement("button").attrs({class:"input_run icon"}).props({onclick(){o()}});function o(e){e&&e.preventDefault(),move(`./?keyword=${i.firstChild.value}`)}return i.firstChild.attrs({placeHolder:TEXTS.search_i}).props({onkeydown(e){13==e.keyCode&&o(e)},value:t.get("keyword")}),a.append(n,i),i.append(r),a}}class articleIndex extends articleBase{constructor(e){super(),this.contentBase=IndexContent;let t=e.get("post");if(t)document.title=`${TEXTS.sitename} :: 로딩중`,(async()=>{"random"==t&&(t=await firebase.search.random());let e=(await firebase.post.selectOne(t)).data();if(null==e)return move(`404?message=${encodeURI("존재하지 않는 문서입니다.")}&url=${location.href}`,!0);if(e.deleted)return move(`404?message=${encodeURI("삭제된 문서입니다.")}&url=${location.href}`,!0);if(e.hidden&&e.author!=app.user?.uid)return move(`403?message=${encodeURI("타인의 숨긴 문서는 조회가 불가합니다.")}&url=${location.href}`,!0);history.replaceState({},"",location.href.replace("post=random",`post=${t}`)),app.saveVisited(t,e.title,e.board_name),document.title=`${TEXTS.sitename} :: ${e.title}`;let a=[this.createContent("zoom"),this.createContent("main_header",void 0,{text:e.title,permission:app.user?app.user.uid===e.author?FINAL.PERMISSION.RWD:FINAL.PERMISSION.RW:FINAL.PERMISSION.R,post_id:t}),this.createContent("sub_header","c_timestamp",{text:new Date(1e3*e.timestamp.seconds).toLocaleString()}),createElement("div").css({"text-align":"left"}).css({"line-height":"2rem"})];a[3].append(createElement("a").attrs({class:"tag",href:`/?field=category&operator=equal&keyword=${e.category}`}).props({innerHTML:`카테고리:${e.category}`}).css({display:"inline-block","line-height":1.2}),createElement("a").attrs({class:"tag",href:`/?field=board_name_arr&operator=array-contains&keyword=${e.board_name}`}).props({innerHTML:`분류:${e.board_name_arr?.join(" > ")||e.board_name}`}).css({display:"inline-block","line-height":1.2}),createElement("a").attrs({class:"tag",href:`/profile?uid=${e.author}`}).props({innerHTML:"사용자 페이지"}).css({display:"inline-block","line-height":1.2}));let n=[],i=0,r=1,o="",s=[];for(let t of e.contents){let e,l=t.value,c=this.createContent(t.type,void 0,l);switch(t.type){case"title":if(e={content:c,title:c.innerHTML},r<l.depth)o+=`${i}.`,s.push({depth:++r,prefix:o,index_str:o+"1.",index:i=1,...e});else if(r==l.depth)s.push({depth:r,prefix:o,index:++i,index_str:o+`${i}.`,...e});else{let t=s.findLast((e=>e.depth==l.depth));s.push({depth:r=l.depth,prefix:o=t.prefix,index:i=t.index+1,index_str:o+`${i}.`,...e})}break;case"summury":n.push(c);break;case"textbox":for(let e of Array.from(c.querySelectorAll('[style*="font-size"]')))e.style.fontSize.endsWith("rem")&&e.css({"font-size":10*parseFloat(e.style.fontSize)+"px"})}a.push(c)}n.length>0&&s.forEach((e=>{e.content.prepend(createElement("a").props({innerHTML:`${e.index_str} `,id:`_${e.index_str.split(".").join("_")}`,onclick(e){e.preventDefault()}}).attrs({href:"#summury"}))}));for(let e of n)e.append.apply(e,s.map((e=>createElement("a").attrs({href:`#_${e.index_str.split(".").join("_")}`}).props({innerHTML:`${e.index_str} <span>${e.title}</span>`,onclick(e){e.preventDefault()}}).css({"margin-left":1.5*e.depth+"rem"}))));if(html_annotation.length>0){let e=createElement("div").addClass("content","annotation","flex-vertical");e.innerHTML=html_annotation,html_annotation="",a.push(e)}a.push(footer),article.append.apply(article,a)})();else{let t=e.get("keyword")||"",a=e.get("field")||"title_arr",n=e.get("operator")||"contains";t?(document.title=`${t} :: ${TEXTS.search_result_title} - ${TEXTS.sitename}`,article.append(this.createContent("zoom"),this.createContent("main_header",void 0,{text:TEXTS.search_result_title,permission:FINAL.PERMISSION.R}),this.createContent("sub_header","c_timestamp",{text:(new Date).toLocaleString()}),this.createContent("title","title_all",{text:TEXTS.all_document}),this.createContent("list","list_all",{style:"table",page_offset:5,keyword:t,field:a,operator:n,searchData:{hidden:{op:"equal",key:!1}}}),footer),this.timeout_timer=setTimeout((()=>{this.interval_timer=setInterval((()=>{this.components.c_timestamp.wrap.innerHTML=(new Date).toLocaleString()}),1e3)}),1e3-(new Date).getMilliseconds()),this.data.Board=new Model(Options.get("board"),null,(function(e){for(let t of article.querySelectorAll("[data-board]")){let a=e.find((e=>e.value==t.getAttribute("data-board")));a&&(t.innerHTML=a.path)}})),this.data.Board.bind(this.components.list_all),this.data.Board.proceed()):(document.title=`${TEXTS.sitename} :: ${TEXTS.site_index}`,article.append(this.createContent("zoom"),this.createContent("main_header",void 0,{text:TEXTS.welcome_title,permission:FINAL.PERMISSION.R}),this.createContent("sub_header","c_timestamp",{text:(new Date).toLocaleString()}),this.createContent("notice"),this.createContent("textbox",void 0,'<br><div style="text-align: center;"><span style="color: #039BE5; font-size: 38px;">환영합니다!</span></div><div style="text-align: center;"><span style="font-weight: bold; font-size: 39px; color: #039BE5;">네무위키</span><span style="font-size: 38px;">입니다</span></div><div style="text-align: center;">※ 정확하지 않은 내용이 있을 수있으며</div><div style="text-align: center;">현실의 인물, 단체, 사건과는 관련이 없습니다</div><br>'),this.createContent("table",void 0,{cellColors:["",""],cells:["%{display:block;text-align:center}처음이라면\n[link:https://www.nemuwiki.com/?post=QFFrhNhkjXqDGnKXdiC8;사용_가이드]%","%{display:block;text-align:center}익숙하다면\n[link:https://www.nemuwiki.com/profile;사용자_문서]%"],header:[0,0],innerLineColor:"var(--clr-primary-base)",outerLineColor:"transparent",outerLineWidth:"1",rowcount:1,isFullWidth:!0}),this.createContent("title","title_all",{text:TEXTS.all_document}),this.createContent("list","list_all",{style:"table",page_offset:5,keyword:t,field:a,operator:n,searchData:{hidden:{op:"equal",key:!1}}}),this.createContent("title","title_character",{text:TEXTS.character_document}),this.createContent("list","list_character",{style:"galery",keyword:"인물",field:"category",operator:"equal",searchData:{hidden:{op:"equal",key:!1}}}),footer),this.components.title_all.wrap.addClass("fold"),this.components.list_all.wrap.addClass("hide"),this.timeout_timer=setTimeout((()=>{this.interval_timer=setInterval((()=>{this.components.c_timestamp.wrap.innerHTML=(new Date).toLocaleString()}),1e3)}),1e3-(new Date).getMilliseconds()),this.data.Board=new Model(Options.get("board"),null,(function(e){for(let t of article.querySelectorAll("[data-board]")){let a=e.find((e=>e.value==t.getAttribute("data-board")));a&&(t.innerHTML=a.path)}})),this.data.Board.bind(this.components.list_all),this.data.Board.bind(this.components.list_character),this.data.Board.proceed())}}destroy(){this.timeout_timer&&clearTimeout(this.timeout_timer),this.interval_timer&&clearInterval(this.interval_timer)}}const IndexContent={...ContentBase,notice:{async initialize(e,t){t.style.display="none";let a=(await firebase.notice.getNewest()).docs[0];if(!a)return;let n=a.data(),i=this.components[e].title=createElement("span").attrs({class:"notice__title icon icon-bullhorn-variant"}).props({innerHTML:n.title,onclick(){t.toggleClass("open")}}),r=this.components[e].timestamp=createElement("span").attrs({class:"notice__timestamp"}).props({innerHTML:new Date(1e3*n.timestamp.seconds).toLocaleDateString()}),o=this.components[e].content=createElement("span").attrs({class:"notice__content"}).props({innerHTML:markdown(n.content)});t.addClass("flex-vertical").append(i,r,o),t.style.removeProperty("display")}}};export{asideIndex as aside,articleIndex as article};