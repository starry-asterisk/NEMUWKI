/**
* Project: nemuwiki.com
* Version: 2.4.0 | product
* Author: @NEMUWIKI
* Date: 2025-04-16
* Description: personal wiki project for NEMU
*/

class asideIndex extends asideBase{constructor(e){super(),aside.addClass("fold");let t=new URLSearchParams;t.set("field","board_name_arr"),t.set("operator","array-contains"),aside.append(this.createBlock("B000",`<h1><a class="logo s_button" href="./">${DIALOG_TEXTS.title}</a></h1>`),this.createSearch("search",e),this.createBlock("btn_upload",`<button class="s_button" onclick="move('write')">${TEXTS.upload}</button><button class="s_button" onclick=" move('/profile')">${TEXTS.mypage}</button>`),this.createBlock("btn_login",`<button class="s_button" onclick="move('/login')">${TEXTS.form.login}</button>`))}createSearch(e,t){let a=createElement("div").addClass("f_block","flex-horizontal").css({marginBottom:"var(--spacing-large)"}).props({id:`${e}_wrap`}),i=createElement("button").attrs({class:"menu_fold icon"}).props({onclick(){aside.toggleClass("fold")}}),n=this.createInput(e).addClass("icon"),s=createElement("button").attrs({class:"input_run icon"}).props({onclick(){l()}});function l(e){e&&e.preventDefault(),move(`./?keyword=${n.firstChild.value}`)}return n.firstChild.attrs({placeHolder:TEXTS.search_i}).props({onkeydown(e){13==e.keyCode&&l(e)},value:t.get("keyword")}),a.append(i,n),n.append(s),a}}class articleIndex extends articleBase{constructor(e){super(),this.contentBase=IndexContent;let t=e.get("dialog");if(t)document.title=`${DIALOG_TEXTS.title} :: 로딩중`,(async()=>{let e=(await firebase.dialog.selectOne(t)).data();if(null==e)return move(`404?message=${encodeURI("존재하지 않는 문서입니다.")}&url=${location.href}`,!0);if(e.deleted)return move(`404?message=${encodeURI("삭제된 문서입니다.")}&url=${location.href}`,!0);if(e.hidden&&e.author!=app.user?.uid)return move(`403?message=${encodeURI("타인의 숨긴 문서는 조회가 불가합니다.")}&url=${location.href}`,!0);document.title=`${DIALOG_TEXTS.title} :: ${e.title}`;let a=[this.createContent("zoom"),this.createContent("main_header",void 0,{text:e.title,permission:app.user?app.user.uid===e.author?FINAL.PERMISSION.RWD:FINAL.PERMISSION.RW:FINAL.PERMISSION.R,dialog_id:t}),this.createContent("sub_header","c_timestamp",{text:new Date(1e3*e.timestamp.seconds).toLocaleString()}),createElement("div").css({"text-align":"left"}).css({"line-height":"2rem"})];a[3].append(createElement("a").attrs({class:"tag",href:`/profile?uid=${e.author}`}).props({innerHTML:"사용자 페이지"}).css({display:"inline-block","line-height":1.2}));let i=[],n=0,s=1,l="",r=[];for(let t of e.contents){let e,o=t.value,d=this.createContent(t.type,void 0,o);switch(t.type){case"title":if(e={content:d,title:d.innerHTML},s<o.depth)l+=`${n}.`,r.push({depth:++s,prefix:l,index_str:l+"1.",index:n=1,...e});else if(s==o.depth)r.push({depth:s,prefix:l,index:++n,index_str:l+`${n}.`,...e});else{let t=r.findLast((e=>e.depth==o.depth));r.push({depth:s=o.depth,prefix:l=t.prefix,index:n=t.index+1,index_str:l+`${n}.`,...e})}break;case"summury":i.push(d);break;case"textbox":for(let e of Array.from(d.querySelectorAll('[style*="font-size"]')))e.style.fontSize.endsWith("rem")&&e.css({"font-size":10*parseFloat(e.style.fontSize)+"px"})}a.push(d)}i.length>0&&r.forEach((e=>{e.content.prepend(createElement("a").props({innerHTML:`${e.index_str} `,id:`_${e.index_str.split(".").join("_")}`,onclick(e){e.preventDefault()}}).attrs({href:"#summury"}))}));for(let e of i)e.append.apply(e,r.map((e=>createElement("a").attrs({href:`#_${e.index_str.split(".").join("_")}`}).props({innerHTML:`${e.index_str} <span>${e.title}</span>`,onclick(e){e.preventDefault()}}).css({"margin-left":1.5*e.depth+"rem"}))));if(html_annotation.length>0){let e=createElement("div").addClass("content","annotation","flex-vertical");e.innerHTML=html_annotation,html_annotation="",a.push(e)}a.push(footer),article.append.apply(article,a)})();else{let t=e.get("keyword")||"",a=e.get("field")||"title_arr",i=e.get("operator")||"contains";t?(document.title=`${t} :: ${TEXTS.search_result_title} - ${DIALOG_TEXTS.title}`,article.append(this.createContent("zoom"),this.createContent("main_header",void 0,{text:TEXTS.search_result_title,permission:FINAL.PERMISSION.R}),this.createContent("sub_header","c_timestamp",{text:(new Date).toLocaleString()}),this.createContent("list","list_all",{style:"table",page_offset:5,keyword:t,field:a,operator:i,searchData:{hidden:{op:"equal",key:!1}}}),footer),this.timeout_timer=setTimeout((()=>{this.interval_timer=setInterval((()=>{this.components.c_timestamp.wrap.innerHTML=(new Date).toLocaleString()}),1e3)}),1e3-(new Date).getMilliseconds()),this.data.Board=new Model(Options.get("board"),null,(function(e){for(let t of article.querySelectorAll("[data-board]")){let a=e.find((e=>e.value==t.getAttribute("data-board")));a&&(t.innerHTML=a.path)}})),this.data.Board.bind(this.components.list_all),this.data.Board.proceed()):(document.title=`${DIALOG_TEXTS.title} :: ${TEXTS.site_index}`,article.append(this.createContent("zoom"),this.createContent("main_header",void 0,{text:DIALOG_TEXTS.title,permission:FINAL.PERMISSION.R}),this.createContent("sub_header","c_timestamp",{text:(new Date).toLocaleString()}),this.createContent("list","list_all",{style:"table",page_offset:5,keyword:t,field:a,operator:i,searchData:{hidden:{op:"equal",key:!1}}}),footer),this.timeout_timer=setTimeout((()=>{this.interval_timer=setInterval((()=>{this.components.c_timestamp.wrap.innerHTML=(new Date).toLocaleString()}),1e3)}),1e3-(new Date).getMilliseconds()),this.data.Board=new Model(Options.get("board"),null,(function(e){for(let t of article.querySelectorAll("[data-board]")){let a=e.find((e=>e.value==t.getAttribute("data-board")));a&&(t.innerHTML=a.path)}})),this.data.Board.bind(this.components.list_all),this.data.Board.proceed())}}destroy(){this.timeout_timer&&clearTimeout(this.timeout_timer),this.interval_timer&&clearInterval(this.interval_timer)}}const IndexContent={...ContentBase,list:{async initialize(e,t,a){let i,{page_offset:n}=a,{next:s}=await firebase.dialogIndex.list(),l="galery"==a.style,r=l?"flex-vertical":"flex-horizontal",o=async()=>{d.disabled=!0,i=await s();for(let e of i){let a,i=e.data(),n=createElement("span").addClass("list__item",r),s=createElement("a").attrs({class:"list__item__title",href:`/dialog/?post=${e.id}`}).props({innerHTML:i.title}),o=createElement("div").addClass("list__item__alt").props({onclick:onclick});if(i.thumbnail&&"undefined"!=i.thumbnail&&(a=createElement("img").attrs({class:"list__item__img"}).props({onerror(){this.replaceWith(o)}}),a.src=i.thumbnail.startsWith("http")?imgurThumb(i.thumbnail,"m"):firebase.storage.getStaticUrl(i.thumbnail)),l)a&&a.props({onclick(){move(s.href)}}),n.append(a||o,s);else{if(a){let e=createElement("span").addClass("list__item__preview","icon","icon-image").props({onmouseover(e){a.css({top:e.clientY-10+"px",left:e.clientX-10+"px"})}});e.append(a),s.append(e)}n.append(s)}t.append(n)}i.length<(a.page_offset||25)&&d.remove(),d.disabled=!1,this.data.Board&&this.data.Board.proceed()},d=createElement("button").props({innerHTML:TEXTS.load_more,onclick:o}).addClass("list__footer","b_button",r);if(l)t.addClass(a.style).append(d);else{let e=createElement("span").addClass("list__header","flex-horizontal");e.append(createElement("a").attrs({class:"list__item__title"}).props({innerHTML:TEXTS.title})),t.addClass("flex-vertical",a.style).append(e,d)}await o()}}},DIALOG_TEXTS={title:"네무로그"};export{asideIndex as aside,articleIndex as article};