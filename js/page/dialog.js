/**
* Project: nemuwiki.com
* Version: 2.5.1 | product
* Author: @NEMUWIKI
* Date: 2025-06-14
* Description: personal wiki project for NEMU
*/

class asideIndex extends asideBase{constructor(e){super(),aside.addClass("fold");let t=new URLSearchParams;t.set("field","board_name_arr"),t.set("operator","array-contains"),aside.append(this.createBlock("B000",`<h1><a class="logo s_button" href="./">${DIALOG_TEXTS.title}</a></h1>`),this.createBlock("btn_upload",`${app.user&&["assume.nameless@gmail.com","6507055@gmail.com"].indexOf(app.user.email)?"":'<button class="s_button" onclick="move(\'write\')">'+TEXTS.upload+"</button>"}<button class="s_button" onclick=" move('/profile')">${TEXTS.mypage}</button>`),this.createBlock("btn_login",`<button class="s_button" onclick="move('/login')">${TEXTS.form.login}</button>`))}createSearch(e,t){let a=createElement("div").addClass("f_block","flex-horizontal").css({marginBottom:"var(--spacing-large)"}).props({id:`${e}_wrap`}),i=createElement("button").attrs({class:"menu_fold icon"}).props({onclick(){aside.toggleClass("fold")}}),n=this.createInput(e).addClass("icon"),s=createElement("button").attrs({class:"input_run icon"}).props({onclick(){l()}});function l(e){e&&e.preventDefault(),move(`./?keyword=${n.firstChild.value}`)}return n.firstChild.attrs({placeHolder:TEXTS.search_i}).props({onkeydown(e){13==e.keyCode&&l(e)},value:t.get("keyword")}),a.append(i,n),n.append(s),a}}class articleIndex extends articleBase{constructor(e){super(),this.contentBase=IndexContent;let t=e.get("dialog");t?(document.title=`${DIALOG_TEXTS.title} :: 로딩중`,(async()=>{let e=(await firebase.dialog.selectOne(t)).data();if(null==e)return move(`404?message=${encodeURI("존재하지 않는 문서입니다.")}&url=${location.href}`,!0);if(e.deleted)return move(`404?message=${encodeURI("삭제된 문서입니다.")}&url=${location.href}`,!0);if(e.hidden&&e.author!=app.user?.uid)return move(`403?message=${encodeURI("타인의 숨긴 문서는 조회가 불가합니다.")}&url=${location.href}`,!0);document.title=`${DIALOG_TEXTS.title} :: ${e.title}`;let a=[this.createContent("zoom"),this.createContent("main_header",void 0,{text:e.title,permission:app.user&&["assume.nameless@gmail.com","6507055@gmail.com"].indexOf(app.user.email)>-1?FINAL.PERMISSION.RWD:FINAL.PERMISSION.R,dialog_id:t,doc_index:e.doc_index}),this.createContent("sub_header","c_timestamp",{text:new Date(1e3*e.timestamp.seconds).toLocaleString()}),createElement("div").css({"text-align":"left"}).css({"line-height":"2rem"})];a[3].append(createElement("a").attrs({class:"tag",href:"/dialog"}).props({innerHTML:"목록"}).css({display:"inline-block","line-height":1.2}));let i=[],n=0,s=1,l="",o=[];for(let t of e.contents){let e,r=t.value,d=this.createContent(t.type,void 0,r);switch(t.type){case"title":if(e={content:d,title:d.innerHTML},s<r.depth)l+=`${n}.`,o.push({depth:++s,prefix:l,index_str:l+"1.",index:n=1,...e});else if(s==r.depth)o.push({depth:s,prefix:l,index:++n,index_str:l+`${n}.`,...e});else{let t=o.findLast((e=>e.depth==r.depth));o.push({depth:s=r.depth,prefix:l=t.prefix,index:n=t.index+1,index_str:l+`${n}.`,...e})}break;case"summury":i.push(d);break;case"textbox":for(let e of Array.from(d.querySelectorAll('[style*="font-size"]')))e.style.fontSize.endsWith("rem")&&e.css({"font-size":10*parseFloat(e.style.fontSize)+"px"})}a.push(d)}i.length>0&&o.forEach((e=>{e.content.prepend(createElement("a").props({innerHTML:`${e.index_str} `,id:`_${e.index_str.split(".").join("_")}`,onclick(e){e.preventDefault()}}).attrs({href:"#summury"}))}));for(let e of i)e.append.apply(e,o.map((e=>createElement("a").attrs({href:`#_${e.index_str.split(".").join("_")}`}).props({innerHTML:`${e.index_str} <span>${e.title}</span>`,onclick(e){e.preventDefault()}}).css({"margin-left":1.5*e.depth+"rem"}))));if(html_annotation.length>0){let e=createElement("div").addClass("content","annotation","flex-vertical");e.innerHTML=html_annotation,html_annotation="",a.push(e)}a.push(footer),article.append.apply(article,a)})()):(document.title=`${DIALOG_TEXTS.title} :: ${TEXTS.site_index}`,article.append(this.createContent("zoom"),this.createContent("main_header",void 0,{text:DIALOG_TEXTS.title,permission:FINAL.PERMISSION.R}),this.createContent("sub_header","c_timestamp",{text:(new Date).toLocaleString()}),this.createContent("list","list_all",{style:"table",page_offset:5}),footer),this.timeout_timer=setTimeout((()=>{this.interval_timer=setInterval((()=>{this.components.c_timestamp.wrap.innerHTML=(new Date).toLocaleString()}),1e3)}),1e3-(new Date).getMilliseconds()),this.data.Board=new Model(Options.get("board"),null,(function(e){for(let t of article.querySelectorAll("[data-board]")){let a=e.find((e=>e.value==t.getAttribute("data-board")));a&&(t.innerHTML=a.path)}})),this.data.Board.bind(this.components.list_all),this.data.Board.proceed())}destroy(){this.timeout_timer&&clearTimeout(this.timeout_timer),this.interval_timer&&clearInterval(this.interval_timer)}}const IndexContent={...ContentBase,list:{async initialize(e,t,a){let i,{page_offset:n}=a,{next:s}=await firebase.dialogIndex.list(),l="galery"==a.style,o=l?"flex-vertical":"flex-horizontal";if(i=await s(),0==i.length)return;var r=i[0].data().list;let d=async()=>{let e=-1;c.disabled=!0;for(let a of r){if(a.deleted)continue;if(e++,e>n)break;let i,s=createElement("span").addClass("list__item",o),r=createElement("a").attrs({class:"list__item__title",href:`/dialog/?dialog=${a.id}`}).props({innerHTML:a.title}),d=createElement("div").addClass("list__item__alt").props({onclick:onclick});if(a.thumbnail&&"undefined"!=a.thumbnail&&(i=createElement("img").attrs({class:"list__item__img"}).props({onerror(){this.replaceWith(d)}}),i.src=a.thumbnail.startsWith("http")?imgurThumb(a.thumbnail,"m"):firebase.storage.getStaticUrl(a.thumbnail)),l)i&&i.props({onclick(){move(r.href)}}),s.append(i||d,r);else{if(i){let e=createElement("span").addClass("list__item__preview","icon","icon-image").props({onmouseover(e){i.css({top:e.clientY-10+"px",left:e.clientX-10+"px"})}});e.append(i),r.append(e)}s.append(r)}t.append(s)}e<(a.page_offset||25)&&c.remove(),c.disabled=!1,this.data.Board&&this.data.Board.proceed()},c=createElement("button").props({innerHTML:TEXTS.load_more,onclick:d}).addClass("list__footer","b_button",o);if(l)t.addClass(a.style).append(c);else{let e=createElement("span").addClass("list__header","flex-horizontal");e.append(createElement("a").attrs({class:"list__item__title"}).props({innerHTML:TEXTS.title})),t.addClass("flex-vertical",a.style).append(e,c)}await d()}},main_header:{initialize(e,t,a){let i=createElement("span").addClass("main_header__title","flex-horizontal").props({innerHTML:a.text}),n=createElement("div").attrs({class:"main_header__buttons buttons"});a.permission>=FINAL.PERMISSION.R&&n.append(createElement("button").props({innerHTML:TEXTS.share,onclick:()=>goShare("twitter")})),a.permission>=FINAL.PERMISSION.RW&&n.append(createElement("button").props({innerHTML:TEXTS.edit,onclick:()=>move(`write?dialog=${a.dialog_id}`)})),a.permission>=FINAL.PERMISSION.RWD&&n.append(createElement("button").props({innerHTML:TEXTS.delete,onclick:function(){remove(this,a.dialog_id,a.doc_index)}})),t.addClass("fold-end","flex-horizontal").append(i,n)}}};function remove(e,t,a,i){Notify.confirm("정말로 삭제 하시겠습니까?")&&Notify.confirm("안내 : 삭제 이후 5일 이상이 경과하면 삭제가 불가할 수 있습니다")&&(e.setAttribute("disabled",!0),firebase.dialog.deleteTemporary(t,void 0,i).then((async()=>{let{next:e}=firebase.dialogIndex.list(),t=await e();if(t.length>0){console.log("docs",t);var i=await t[0].data();i.list[a]={deleted:!0},await firebase.dialogIndex.set(t[0].id,i)}move(ROOT_PATH+"dialog",!0)})).catch(firebaseErrorHandler))}const DIALOG_TEXTS={title:"네무로그"};export{asideIndex as aside,articleIndex as article};