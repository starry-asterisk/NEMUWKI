/**
* Project: nemuwiki.com
* Version: 2.5.0 | product
* Author: @NEMUWIKI
* Date: 2025-04-16
* Description: personal wiki project for NEMU
*/

class Router{VISITED_MAX=5;pageClasses={};histories=[];visited=[];now="";state=null;user=null;blockMode=!1;loginCallback=()=>{};logoutCallback=()=>{};constructor(){localStorage.getItem("visited")&&(this.visited=localStorage.getItem("visited").split(","))}async load(e=location.pathname,t=location.search){now={path:e,search:t};let a=new URLSearchParams(t),o=e.split("/"),n=o.pop(),r=o.pop(),i=await this.getClass(`/${n||r||""}`);document.body.removeClass("preview-mode"),this.blockMode=!1,__CallStack__={categories:[],board:[]},this.loginCallback=i.loginCallback||(()=>{}),this.logoutCallback=i.logoutCallback||(()=>{}),app_aside=new i.aside(a),app_article=new i.article(a),this.histories.push({app_aside:app_aside,app_article:app_article})}async getClass(e){let t="404";switch(e){case"/":case"/index":t="index";break;case"/login":case"/signup":t="login";break;case"/form":t="form";break;case"/profile":t="profile";break;case"/setting":t="setting";break;case"/dialog":t="dialog";break;case"/write":t="dialog-write"}return this.now=e,this.pageClasses[t]||(this.pageClasses[t]=await import(`./page/${t}.js?version=${version}`))}getVisited(){return this.visited.map((e=>{let t=e.split(":");return{visited_id:decodeVisited(t[0]),title:decodeVisited(t[1]),board_name:decodeVisited(t[2])}}))}saveVisited(e,t,a){let o=`${encodeVisited(e)}:${encodeVisited(t)}:${encodeVisited(a)}`,n=this.visited.indexOf(o);n>-1&&this.visited.splice(n,1),this.visited.unshift(o),this.visited.splice(this.VISITED_MAX),localStorage.setItem("visited",this.visited)}}class asideBase{data={};components={};constructor(){emptyNode(aside),aside.removeClass("fold")}update(e,t){this.data[e]instanceof Model&&(this.data[e].datas=t,this.data[e].proceed())}destroy(){}createInput(e,t="text"){let a=createElement().attrs({id:e,class:"input flex-horizontal"}),o=createElement("input").attrs({id:`${e}__input`,type:t});return a.append(o),this.components[e]={input:o,wrap:a},Object.defineProperty(this.data,e,{get:()=>this.components[e].input.value,set:t=>this.components[e].input.value=t}),a}createBlock(e,t,a){let o=createElement().attrs({id:e,class:"block"}).props({innerHTML:t});return a&&o.append(a),this.components[e]={wrap:o},o}createBlockList(e,t,a){let o=createElement().attrs({id:e,class:"b_block block inline"}),n=createElement("button").attrs({class:"block__title icon"}).props({onclick:()=>toggle_block(e),innerHTML:t}),r=createElement("ul").attrs({class:"block__list"});return app.auto_open_menu&&o.addClass("open"),o.append(n,r),this.components[e]={button:n,wrap:o,ul:r},this.data[e]=a,this.data[e]instanceof Model&&(a.bind(this.components[e]),a.proceed()),o}}class articleBase{tabIndex=5;contentBase={};data={};components={};constructor(){emptyNode(article),article.style.removeProperty("zoom")}update(e,t){this.data[e]instanceof Model&&(this.data[e].datas=t,this.data[e].proceed())}destroy(){}createContent(e,t=randomId(),a){let o=createElement("div").attrs({class:`content ${e}`,id:t});return this.components[t]={wrap:o},this.data[t]=a,this.contentBase[e]&&this.contentBase[e].initialize.call(this,t,o,a),o}get focusedElement(){return this._focusedElement}set focusedElement(e){if(this._focusedElement==e)return e;if(e){if(e.parentElement!=article)return;this._focusedElement=e,this.formBase[e.dataset.type]&&this.update("toolbar",this.formBase[e.dataset.type].buttons||[])}else this._focusedElement=null,this.update("toolbar",[]);lastSelection={}}}let lastSelection={};class Model{datas=[];components=[];constructor(e,t,a){e&&(this.datas=e),t&&(this.process=t),a&&(this.preprocess=a)}process(){}preprocess(){}bind(e){this.components.push(e)}proceed(){for(let e of this.components)this.preprocess.call(e,this.datas),this.datas.forEach(this.process.bind(e))}}function createSelect(e,t,a,o=""){let n,r=createElement("n-select").attrs({tabindex:2}),i=createElement("div").attrs({tabindex:3});return a&&(n=createElement("input").attrs({type:"text",placeholder:o}).props({onkeydown(e){e.stopPropagation()},oninput(){r.dataset.selectedtext=this.value||o,r.dataset.value=this.value;for(let e of i.children)e!==this&&(e.innerText.includes(this.value)?e.style.removeProperty("display"):e.style.display="none");l()}}),i.append(n)),o&&i.append(createOption({text:o},r)),i.append.apply(i,e.map((e=>createOption(e,r)))),r.append(i),r.onkeydown=e=>{let t=r.querySelector("n-option[data-selected]");switch(e.keyCode){case 13:e.preventDefault(),r.submit&&r.submit();break;case 37:case 38:e.preventDefault(),t.prev("n-option")?.dispatchEvent(new Event("mousedown"));break;case 39:case 40:e.preventDefault(),t.next("n-option")?.dispatchEvent(new Event("mousedown"))}},r.onmousedown=l,r.ul=i,r.input=n,r.set=(e,t)=>{r.dataset.value=e,r.dataset.selectedtext=t||e,i.querySelector(`option[data-value="${e}"]`)?.dispatchEvent(new Event("mousedown"))},r.ondelete=()=>!0,void 0!==t&&i.children[t].dispatchEvent(new Event("mousedown")),r;function l(){let{y:e,height:t}=r.getBoundingClientRect(),a=e,o=window.innerHeight-t-e,n=a<o;r.toggleClass("to_down",n),r.style.setProperty("--max-dropdown-height",`${Math.min(i.scrollHeight+2,(n?o:a)-60,.4*window.innerHeight)}px`)}}function createOption(e,t){let a=createElement("n-option").attrs({"data-value":e.value,"data-owner":e.is_owner}).toggleClass("placeholder",!e.value).props({innerHTML:e.text||e.value,onmousedown(a){a&&a.stopPropagation();for(let e of Array.from(t.querySelectorAll("n-option[data-selected]")))delete e.dataset.selected;this.dataset.selected=!0,t.dataset.selectedtext=this.innerText,t.dataset.value=e.value||"",t.input&&(t.input.value=this.innerText),t.onselchange&&t.onselchange(t.dataset.value,this.innerText)}});return e.is_owner&&a.append(createElement("button").addClass("del").props({onmousedown(o){o.stopPropagation(),t.ondelete(e.id,a)&&a.remove()}})),t.dataset.value===e.value&&(a.dataset.selected=!0,t.dataset.selectedtext=a.innerText),a}customElements.define("n-table",class extends HTMLElement{_DEFAULT_WIDTH=20;_beforeInit=!0;_editable=!1;_tbody=createElement("div").addClass("n-tbody");_header=createElement("div").addClass("n-th");_rowcount=0;_colcount=0;_outerLineWidth=1;_outerLineColor="#cccccc";_innerLineColor="#cccccc";_isFullWidth=!1;_lastSelection;get cells(){return Array.from(this._tbody.children).map((e=>({value:e.innerHTML,color:e.dataset.color||"",fittocell:"true"==e.dataset.fitToCell})))}get header(){return Array.from(this._header.children).map((e=>e.value))}get rowcount(){return this._rowcount}get colcount(){return this._colcount}get outerLineWidth(){return this._outerLineWidth}get outerLineColor(){return this._outerLineColor}get innerLineColor(){return this._innerLineColor}get isFullWidth(){return this._isFullWidth}get editable(){return this._editable}get lastSelection(){if(this._lastSelection&&this._lastSelection.parentElement)return this._lastSelection}set cells(e){return emptyNode(this._tbody),this._tbody.append.apply(this._tbody,e.map((e=>this.getTd(e)))),this._rowcount=e.length/this._colcount,this.adJustTdPosition(),e}set header(e){return emptyNode(this._header),this._header.append.apply(this._header,e.map((e=>this.getTh(e)))),this.setWidth(e),this._colcount=e.length,this._rowcount=this._tbody.children.length/this._colcount,this.adJustTdPosition(),e}set rowcount(e){return this._rowcount==e?e:(this._rowcount>e?this._tbody.querySelectorAll(`:nth-child(n + ${e*this._colcount+1})`).forEach((e=>e.remove())):this._tbody.append.apply(this._tbody,new Array((e-this._rowcount)*this._colcount).fill({value:""}).map((e=>this.getTd(e)))),this.style.setProperty("--rowcount",e),this.adJustTdPosition(void 0,e),this._rowcount=e)}set colcount(e){return this._colcount==e?e:(this._colcount>e?(this._header.querySelectorAll(`:nth-child(n + ${e+1})`).forEach((e=>e.remove())),Array.from(this._tbody.children).forEach(((t,a)=>{a%this._colcount>=e&&t.remove()}))):(this._header.append.apply(this._header,new Array(e-this._colcount).fill(this._DEFAULT_WIDTH).map((e=>this.getTh(e)))),this._tbody.querySelectorAll(`:nth-child(${this._colcount}n)`).forEach((t=>t.after.apply(t,new Array(e-this._colcount).fill({value:""}).map((e=>this.getTd(e))))))),this.setWidth(Array.from(this._header.children).map((e=>e.value))),this.adJustTdPosition(e),this._colcount=e)}set outerLineWidth(e){return this.style.setProperty("--outer-line-width",`${e}px`),this._outerLineWidth=e}set outerLineColor(e){return this.style.setProperty("--outer-line-color",e),this._outerLineColor=e}set innerLineColor(e){return this.style.setProperty("--inner-line-color",e),this._innerLineColor=e}set isFullWidth(e){return e?this.addClass("full-width"):this.removeClass("full-width"),this._isFullWidth=e}set editable(e){return e?(this.addClass("editable"),this._tbody.querySelectorAll(".n-td").forEach((e=>e.attrs({contenteditable:"plaintext-only"})))):(this.removeClass("editable"),this._tbody.querySelectorAll(".n-td").forEach((e=>e.removeAttribute("contenteditable","plaintext-only")))),this._editable=e}set lastSelection(e){e&&(this._lastSelection=e,this.lastSelection&&(this.onSelChange&&this.onSelChange(this.lastSelection),this.onResize&&this.onResize(this.lastSelection)))}constructor(){super()}connectedCallback(){this.append(this._header,this._tbody)}setWidth(e){let t=0;this.style.setProperty("--columns",e.map((e=>{let a=parseFloat(e)||this._DEFAULT_WIDTH;return t+=a,`${a}fr`})).join(" ")),this.css({width:10*t+"px"})}getTh(e){return createElement("input").addClass("n-td").attrs({type:"number"}).props({value:e,oninput:()=>{this.setWidth(Array.from(this._header.children).map((e=>e.value)))}})}getTd(e){let t=createElement("div").addClass("n-td").props({onfocus:()=>this.lastSelection=t});return t.innerHTML=this._editable?e.value:markdown(e.value||"",t),t.dataset.fitToCell=!!e.fittocell,e.color&&t.css({"background-color":e.color}).attrs({"data-color":e.color}),this._editable&&t.attrs({contenteditable:"plaintext-only"}),t}adJustTdPosition(e=this._colcount,t=this._rowcount){if(e<1||t<1)return;let a=Array.from(this._tbody.children);for(let t in a){let o=1+Number(t)%e||e,n=Math.ceil((1+Number(t))/e),r=Number(a[t].dataset.colspan)||1,i=Number(a[t].dataset.rowspan)||1;a[t].dataset.col=o,a[t].dataset.row=n,a[t].css({"grid-area":`${n} / ${o} / ${n+i} / ${o+r}`}),(r>1||i>1)&&a[t].css({"z-index":"1"})}}});const ContentBase={zoom:{initialize(e,t,a){let o=createElement("span").props({id:""});function n(e,a){const n=parseFloat(article.style.zoom||1);let r=a?parseFloat(e):Math.max((parseFloat(n)+parseFloat(e)).toFixed(1),.1);article.style.zoom=r,t.style.zoom=(1/r).toFixed(2),o.innerHTML=`${Math.floor(100*r)}%`,a||localStorage.setItem("zoom",r)}t.append(createElement("button").props({innerHTML:TEXTS.zoomin,onclick:()=>n(.1,!1)}),o,createElement("button").props({innerHTML:TEXTS.zoomout,onclick:()=>n(-.1,!1)})),n(localStorage.getItem("zoom")||1,!0)}},main_header:{initialize(e,t,a){let o=createElement("span").addClass("main_header__title","flex-horizontal").props({innerHTML:a.text}),n=createElement("div").attrs({class:"main_header__buttons buttons"});a.permission>=FINAL.PERMISSION.R&&n.append(createElement("button").props({innerHTML:TEXTS.share,onclick:()=>goShare("twitter")})),a.permission>=FINAL.PERMISSION.RW&&n.append(createElement("button").props({innerHTML:TEXTS.edit,onclick:()=>move(`form?post=${a.post_id}`)})),a.permission>=FINAL.PERMISSION.RWD&&n.append(createElement("button").props({innerHTML:TEXTS.delete,onclick:function(){remove(this,a.post_id)}})),t.addClass("fold-end","flex-horizontal").append(o,n)}},sub_header:{initialize(e,t,a){t.addClass("fold-end").innerHTML=a.text}},title:{initialize(e,t,a){t.addClass("icon").addClass("fold-end").props({innerHTML:a.text,onclick(){t.toggleClass("fold");let e=t.classList.contains("fold"),a=t;for(;a=a.nextElementSibling;){if(a.classList.contains("fold-end"))return;a.toggleClass("hide",e)}}})}},textbox:{initialize(e,t,a){let o=createElement("template").props({innerHTML:markdown(a)});t.appendChild(o.content)}},table:{initialize(e,t,a){let{cells:o,header:n,cellColors:r=[],outerLineWidth:i=1,outerLineColor:l="#cccccc",innerLineColor:s="#cccccc",isFullWidth:c,align:d,fit:p}=a;"string"==typeof o[0]&&(o=o.map(((e,t)=>({value:e})))),"cellColors"in a&&r.forEach(((e,t)=>{o[t].color=e}));let u=createElement("n-table").props({cells:o,header:n,outerLineWidth:i,outerLineColor:l,innerLineColor:s,isFullWidth:c,editable:!1}).attrs({"data-align":d,"data-fit":p});t.append(u)}},image:{initialize(e,t,a){if("string"==typeof a&&(a={src:a}),a.hidden)return void(t.style.display="none");let o=createElement("img").props({onerror(){this.replaceWith(createElement("div").addClass("img_alt"))}});a.width&&(o.width=a.width),a.align&&(o.dataset.align=a.align),o.src=a.src.startsWith("http")?a.src:firebase.storage.getStaticUrl(a.src),t.append(o)}},youtube:{initialize(e,t,a){let o=getYoutubeId(a.link),n=a.start||0,r=createElement("iframe").attrs({title:"YouTube video player",frameborder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share",referrerpolicy:"strict-origin-when-cross-origin",allowfullscreen:!0,width:530,height:315,src:`//www.youtube.com/embed/${o}?start=${n}`});t.append(r)}},seperator:{initialize(e,t,a){t.addClass("fold-end")}},summury:{initialize(e,t,a){t.addClass("fold-end","flex-vertical"),t.id="summury"}},list:{async initialize(e,t,a){let o,{keyword:n,field:r,operator:i,searchData:l={}}=a,{next:s}=await firebase.search.list({[r]:n,...l},i,a.page_offset||25),c="galery"==a.style,d=c?"flex-vertical":"flex-horizontal",p=async()=>{u.disabled=!0,o=await s();for(let e of o){let a,o=e.data(),n=createElement("span").addClass("list__item",d),r=createElement("a").attrs({class:"list__item__board_name","data-board":o.board_name,href:`?field=board_name_arr&operator=array-contains&keyword=${o.board_name}`}).props({innerHTML:o.board_name}),i=createElement("a").attrs({class:"list__item__title",href:`index?post=${e.id}`}).props({innerHTML:o.title}),l=createElement("div").addClass("list__item__alt").props({onclick:onclick});if(o.thumbnail&&"undefined"!=o.thumbnail&&(a=createElement("img").attrs({class:"list__item__img"}).props({onerror(){this.replaceWith(l)}}),a.src=o.thumbnail.startsWith("http")?imgurThumb(o.thumbnail,"m"):firebase.storage.getStaticUrl(o.thumbnail)),c)a&&a.props({onclick(){move(i.href)}}),n.append(a||l,r,i);else{if(a){let e=createElement("span").addClass("list__item__preview","icon","icon-image").props({onmouseover(e){a.css({top:e.clientY-10+"px",left:e.clientX-10+"px"})}});e.append(a),i.append(e)}n.append(r,i)}t.append(n)}o.length<(a.page_offset||25)&&u.remove(),u.disabled=!1,this.data.Board&&this.data.Board.proceed()},u=createElement("button").props({innerHTML:TEXTS.load_more,onclick:p}).addClass("list__footer","b_button",d);if(c)t.addClass(a.style).append(u);else{let e=createElement("span").addClass("list__header","flex-horizontal");e.append(createElement("a").attrs({class:"list__item__board_name"}).props({innerHTML:TEXTS.document_cate}),createElement("a").attrs({class:"list__item__title"}).props({innerHTML:TEXTS.title})),t.addClass("flex-vertical",a.style).append(e,u)}await p()}},dialog:{initialize(e,t,{align:a="left",image:o={},name:n="",html:r=""}){if(t.dataset.align=a,o.src){let e=createElement("img").props({onerror(){this.replaceWith(createElement("div").addClass("img_alt"))}});e.width=o.width,e.src=o.src.startsWith("http")?o.src:firebase.storage.getStaticUrl(o.src),t.append(e)}else t.addClass("dialog__no_image");let i=createElement("span").addClass("dialog__name").props({innerHTML:n}),l=createElement("div").addClass("dialog__text").props({innerHTML:markdown(r)});t.append(i,l)}}},MODAL_TEMPLATE={colorPicker:(e,t,a)=>{let o=1,n=1,r=0,i=document.createElement("div").addClass("pallet"),l=document.createElement("span").addClass("pallet__picker"),s=document.createElement("div").addClass("hue"),c=document.createElement("span").addClass("hue__picker");i.append(l),i.onmousedown=i.ontouchstart=e=>{let{width:t,height:a,x:r,y:l}=i.getBoundingClientRect();function s(e){if(e.stopPropagation(),e.preventDefault(),e.touches&&(e=e.touches[0]),!e)return;let{clientX:i,clientY:s}=e,c=Math.max(Math.min(i-r,t),0),d=Math.max(Math.min(s-l,a),0);o=c/t,n=1-d/a,f()}s(e),window.onmousemove=window.ontouchmove=e=>s(e),window.onmouseup=window.onmouseleave=window.ontouchend=e=>{s(e),window.onmouseup=window.ontouchmove=window.ontouchend=window.onmouseleave=window.onmousemove=null}},s.append(c),s.onmousedown=s.ontouchstart=e=>{let{width:t,x:a}=s.getBoundingClientRect();function o(e){if(e.stopPropagation(),e.preventDefault(),e.touches&&(e=e.touches[0]),!e)return;let{clientX:o}=e,n=Math.max(Math.min(o-a,t),0);r=Math.floor(n/t*361),f()}o(e),window.onmousemove=window.ontouchmove=e=>o(e),window.onmouseup=window.onmouseleave=window.ontouchend=e=>{o(e),window.onmouseup=window.ontouchmove=window.ontouchend=window.onmouseleave=window.onmousemove=null}};let d=createElement("div").attrs({class:"b_input",placeholder:"hex"}).css({"margin-block":"1rem"}),p=createElement("input").attrs({placeholder:"",maxlength:7}).props({value:"#FFFFFF",oninput(){let{h:e,s:t,v:a}=hexToHsv(p.value);r=e,o=t,n=a,f(!1)}}),u=createElement("button").addClass("icon").addClass("icon-eyedropper").props({onclick(e){e.preventDefault(),e.stopPropagation(),(new EyeDropper).open().then((({sRGBHex:e})=>{let{h:t,s:a,v:i}=hexToHsv(e);r=t,o=a,n=i,f()}))}}),m=createElement("button").props({onclick(a){a.preventDefault(),e.close(),t(p.value)}}).attrs({class:"button primary"}).props({innerHTML:TEXTS.form.apply});d.append(p,u),"EyeDropper"in window||u.remove();let h=document.createDocumentFragment();if(h.append(i,s,d,m),a){let{h:e,s:t,v:i}=hexToHsv(a);r=e,o=t,n=i,f()}return h;function f(e=!0){l.css({bottom:100*n+"%",left:100*o+"%"}),i.css({filter:`hue-rotate(${r}deg)`}),c.css({left:r/3.6+"%"}),e&&(p.value=hsvToHex(r,o,n))}},addAnno:(e,t)=>{let a=document.createDocumentFragment(),o=createElement("h3").props({innerHTML:"주석 추가"}),n=createElement("div").attrs({class:"b_input",placeholder:"주석 번호"}).css({"min-width":"18rem","margin-bottom":"var(--spacing-small)"}),r=createElement("input").attrs({type:"text",placeholder:" "}),i=createElement("div").attrs({class:"b_input",placeholder:"주석 내용"}).css({"min-width":"18rem","margin-bottom":"var(--spacing-small)"}),l=createElement("input").attrs({type:"text",placeholder:" "}),s=createElement("button").props({onclick(a){a.preventDefault(),e.close(),t(r.value,l.value)}}).attrs({class:"button primary"}).props({innerHTML:TEXTS.form.apply});return a.append(o,n,i,s),n.append(r),i.append(l),a},emailPrompt:e=>{let t=document.createDocumentFragment(),a=createElement("h3").props({innerHTML:"비밀번호 초기화"}),o=createElement("div").attrs({class:"b_input",placeholder:"이메일"}).css({"min-width":"18rem","margin-bottom":"var(--spacing-small)"}),n=createElement("input").attrs({type:"text",placeholder:" "}),r=createElement("button").attrs({class:"button primary"}).props({innerHTML:"요청전송"});return t.append(a,o,r),o.append(n),r.onclick=t=>{t.preventDefault(),validate(n,void 0,"email")?firebase.auth.sendPasswordResetEmail(n.value).then((t=>{t&&dev.log(t),Notify.alert("메일이 전송되었습니다."),e.close()})).catch(firebaseErrorHandler):Notify.alert("옳바른 이메일을 입력하세요!")},t},emailConfirm:e=>{let t=document.createDocumentFragment(),a=createElement("h3").props({innerHTML:"메일 인증 요청 보내기"}),o=createElement("button").attrs({class:"button primary"}).props({innerHTML:"요청"});return t.append(a,o),o.onclick=t=>{t.preventDefault(),(async()=>await firebase.auth.sendEmailVerification())().then((t=>{t&&dev.log(t),Notify.alert("메일이 전송되었습니다."),e.close()})).catch(firebaseErrorHandler)},t},addCategory:e=>{let t=document.createDocumentFragment(),a=createElement("h3").props({innerHTML:"카테고리 추가"}),o=createElement("div").attrs({class:"b_input",placeholder:"카테고리명"}).css({"min-width":"18rem","margin-bottom":"var(--spacing-small)"}),n=createElement("input").attrs({type:"text",placeholder:" "}),r=createElement("button").attrs({class:"button primary"}).props({innerHTML:"생성"});return t.append(a,o,r),o.append(n),r.onclick=t=>{if(t.preventDefault(),n.value){if(Notify.confirm("카테고리를 생성하시겠습니까?")){if(Options.categories.find((e=>e.value===n.value)))return Notify.alert("동일 명칭의 카테고리가 이미 존재합니다!!");firebase.categories.insertOne({name:n.value,owner:app.user.uid}).then((()=>{Notify.alert("카테고리가 추가되었습니다."),e.close()})).catch(firebaseErrorHandler)}}else Notify.alert("카테고리 명칭을 입력해 주세요.")},t},addMenu:e=>{e.css({overflow:"visible"});let t=document.createDocumentFragment(),a=createElement("h3").props({innerHTML:"분류 추가"}),o=createSelect(Options.get("board"),0,!0,"상위 분류").addClass("input","flex-horizontal").css({"margin-bottom":"var(--spacing-small)","max-width":"100%","min-width":"15rem"}),n=createElement("div").attrs({class:"b_input",placeholder:"분류명"}).css({"min-width":"18rem","margin-bottom":"var(--spacing-small)"}),r=createElement("input").attrs({type:"text",placeholder:" "}),i=createElement("button").attrs({class:"button primary"}).props({innerHTML:"생성"});return t.append(a,o,n,i),n.append(r),i.onclick=t=>{if(t.preventDefault(),r.value){if(Notify.confirm("메뉴를 생성하시겠습니까?")){if(Options.board.find((e=>e.name===r.value)))return Notify.alert("동일 명칭의 메뉴가 이미 존재합니다!!");let t={depth:0,name:""};if(o.dataset.value){let e=Options.board.find((e=>e.name===o.dataset.value));if(!e)return Notify.alert("존재하지 않는 상위 메뉴입니다!!");t=e}firebase.board.insertOne({name:r.value,parent:t.name,depth:t.depth+1,owner:app.user.uid}).then((()=>{Notify.alert("메뉴가 추가되었습니다."),e.close()})).catch(firebaseErrorHandler)}}else Notify.alert("메뉴 명칭을 입력해 주세요.")},setTimeout((()=>{document.activeElement?.blur()}),10),t},addImg:(e,t)=>{e.classList.add("imgSelector","fullSize");let a=document.createDocumentFragment(),o=createElement("div").attrs({class:"imgSelector__header"}).props({innerHTML:"이미지 선택"}),n=createElement("button").attrs({class:"button primary"}).props({value:"default",innerHTML:"선택"}),r=createElement("div").attrs({class:"imgSelector__list"}),i=createElement("input").attrs({type:"file",accept:"image/*"}),l=createElement("label").attrs({class:"imgSelector__list__item icon icon-tray-arrow-up"}),s=createElement("button").attrs({class:"imgSelector__list__item link"});return a.append(o),a.append(n),a.append(r),l.append(i),r.append(l),r.append(s),i.onchange=async()=>{let a=i.files[0];if(a){let o=await uploadByImgur(a);200===o.status?(e.close(),t(o.data.link)):(Notify.alert("Imgur사이트 파일 업로드에 실패했습니다."),i.setAttribute("type","text"),i.value="",i.setAttribute("type","file"))}},s.onclick=a=>{a.preventDefault();let o=Notify.prompt("사용할 이미지의 URL을 입력해 주세요");o&&(e.close(),t(o))},firebase.resources.all().then((e=>{for(let t of e.docs){let e=t.data(),a=createElement("input").attrs({type:"radio",class:"imgSelector__list__item",name:"gallery"}).css({"background-image":`url(${imgurThumb(e.link,"m")})`}).props({value:e.link});r.append(a)}})),n.onclick=a=>{a.preventDefault();let o=r.querySelector(":checked");o?(e.close(),t(o.value)):Notify.alert("이미지를 선택해 주세요!!")},a}};function createElement(e="div"){return document.createElement(e)}function emptyNode(e){let t=Array.from(e.childNodes);for(let e of t)e.remove()}function parseHTML(e){let t=document.createDocumentFragment();return t.insertAdjacentHTML("afterbegin",e),t.firstChild}function hsvToHex(e,t,a){let o,n,r,i=a*t,l=i*(1-Math.abs(e/60%2-1)),s=a-i;0<=e&&e<60?(o=i,n=l,r=0):60<=e&&e<120?(o=l,n=i,r=0):120<=e&&e<180?(o=0,n=i,r=l):180<=e&&e<240?(o=0,n=l,r=i):240<=e&&e<300?(o=l,n=0,r=i):(o=i,n=0,r=l);let c=Math.round(255*(o+s)),d=Math.round(255*(n+s)),p=Math.round(255*(r+s));const u=e=>e.toString(16).padStart(2,"0").toUpperCase();return`#${u(c)}${u(d)}${u(p)}`}function hexToHsv(e){let t,a=parseInt(e.substring(1,3),16)/255,o=parseInt(e.substring(3,5),16)/255,n=parseInt(e.substring(5,7),16)/255,r=Math.max(a,o,n),i=r-Math.min(a,o,n);return 0===i?t=0:r===a?t=(o-n)/i%6:r===o?t=(n-a)/i+2:r===n&&(t=(a-o)/i+4),t=Math.round(60*t),t<0&&(t+=360),{h:t,s:0===r?0:i/r,v:r}}function toggle_block(e){window[e].toggleClass("open")}function randomId(){return`_${Math.floor(Math.random()*Math.pow(10,8)).toString(16)}`}function getBoardPath(e){let t=[];for(;e;)t.unshift(e.name),e=e.parent_data;return t.join(" > ")}function firebaseErrorHandler(e){const t=e.code,a=e.message;switch(app&&(app.state=null),t){case"permission-denied":Notify.alert("권한이 없거나 자동 로그아웃 처리되었습니다. 다시 로그인 해주세요."),location.href=ROOT_PATH;break;case"admin-permission-denied":Notify.alert("접근 가능한 관리자가 아닌 계정으로 로그인 되어있습니다. 다시 로그인 해주세요.");break;case"auth/invalid-email":Notify.alert("옳바르지 않거나 존재하지 않는 이메일 입니다.");break;case"auth/missing-password":Notify.alert("패스워드를 입력해주세요.");break;case"auth/invalid-credential":Notify.alert("로그인 인증에 실패했습니다. 패스워드 또는 아이디를 확인해 주세요.");break;case"auth/email-already-in-use":Notify.alert("이미 사용중인 이메일입니다.");break;case"auth/weak-password":Notify.alert("취약한 비밀번호 입니다.");break;default:Notify.alert(`오류가 발생했습니다::${t}:`),dev.error(t,a)}}function remove(e,t,a){Notify.confirm("정말로 삭제 하시겠습니까?")&&Notify.confirm("안내 : 삭제 이후 5일 이상이 경과하면 삭제가 불가할 수 있습니다")&&(e.setAttribute("disabled",!0),firebase.post.deleteTemporary(t,void 0,a).then((async()=>{await firebase.search.unset(t),move(ROOT_PATH,!0)})).catch(firebaseErrorHandler))}function logout(){app&&(app.blockMode=!1),firebase.auth.logout().then((()=>{location.href=ROOT_PATH})).catch(firebaseErrorHandler)}function checkLogin(){firebase.auth.check((e=>{nav__my_btn.innerHTML=TEXTS.form.profile,nav__my_btn.onclick=null,pop_profile.style.removeProperty("display"),app.user=e,firebase.auth.getUser().then((e=>{let t=e.data();app.userData=t,t.banner_url&&profile__background.css({display:"block"})&&(profile__background.src=t.banner_url),t.photo_url&&profile__avatar.css({display:"block"})&&(profile__avatar.src=t.photo_url),t.theme_color&&applyThemes(t.theme_color),t.theme_sub_color&&document.body.style.setProperty("--color-bg-light",t.theme_sub_color),t.auto_open_menu&&openAllFold(),profile__email.innerHTML=t.email})).catch(firebaseErrorHandler),app.loginCallback(e),document.body.removeClass("none-auth")}),(()=>{nav__my_btn.innerHTML=TEXTS.form.login,nav__my_btn.onclick=()=>{move("login")},profile__background.css({display:"none"}),profile__avatar.css({display:"none"}),profile__email.innerHTML="",pop_profile.css({display:"none"}),app.user=!1,removeThemes(),app.logoutCallback(),document.body.addClass("none-auth")}))}function applyThemes(e){e?(document.documentElement.style.setProperty("--light-blue-300",e),document.documentElement.style.setProperty("--light-blue-400",e),document.documentElement.style.setProperty("--light-blue-500",e),document.documentElement.style.setProperty("--light-blue-600",e),document.documentElement.style.setProperty("--light-blue-700",e),document.documentElement.style.setProperty("--light-blue-800",e),document.documentElement.style.setProperty("--light-blue-a400",e+"97"),document.documentElement.style.setProperty("--light-blue-visited",e+"aa"),localStorage.setItem("theme_color",e)):removeThemes()}function removeThemes(){document.body.style.removeProperty("--light-blue-300"),document.body.style.removeProperty("--light-blue-400"),document.body.style.removeProperty("--light-blue-500"),document.body.style.removeProperty("--light-blue-600"),document.body.style.removeProperty("--light-blue-700"),document.body.style.removeProperty("--light-blue-800"),document.body.style.removeProperty("--light-blue-a400"),document.body.style.removeProperty("--light-blue-visited"),localStorage.removeItem("theme_color")}function openAllFold(){app.auto_open_menu=!0;let e=document.querySelectorAll(".b_block");for(let t of e)t.addClass("open");let t=document.querySelectorAll(".content.title.icon.fold-end.fold");for(let e of t)e.click()}function listenCategories(){"categories"in Listerners||(Listerners.categories=firebase.listen(firebase.categories.query(),(e=>{Options.categories=Array.prototype.map.call(e.docs,(e=>{let t=e.data();return t.id=e.id,t}));let t=Options.get("categories");app_aside.update("Categories",t),__CallStack__.categories.forEach((e=>e(t)))})))}function listenBoard(){"board"in Listerners||(Listerners.board=firebase.listen(firebase.board.query(),(e=>{Options.board=Array.prototype.map.call(e.docs,(e=>{let t=e.data();return t.id=e.id,t.children=[],t}));for(let e of Options.board){let t=Options.board.find((t=>e.parent==t.name&&e.depth-1==t.depth));t&&(t.children.push(e),e.parent_data=t)}var t=Options.get("board");app_aside.update("Board",t),app_article.update("Board",t),__CallStack__.board.forEach((e=>e(t)))})))}function validate(e,t,a="text"){if(null!=e.value&&""!=e.value)if(e.setCustomValidity("valueMissing"),null==t||e.value==t.value)switch(t&&t.setCustomValidity(""),a){case"email":/^\S+@\S+$/.test(e.value)?e.setCustomValidity(""):e.setCustomValidity("typeMismatch");break;case"password":e.value.length>7?e.setCustomValidity(""):e.setCustomValidity("tooShort")}else t.setCustomValidity("valueMisMatch");else e.setCustomValidity("valueMissing");return e.checkValidity()}function encodeVisited(e){return e.replace(/:/g,"&colon;")}function decodeVisited(e){return e.replace(/&colon;/g,":")}function move(e,t,a=!0){document.activeElement&&document.activeElement.blur();let{isInlink:o,path:n,search:r,hash:i}=parseUrl(e);if(o){if(app.blockMode&&(app.blockMode=!Notify.confirm(TEXTS.warn.beforeunload)),app.blockMode)return!0;t?history.replaceState({},"",`${n+r+i}`):history.pushState({},"",`${n+r+i}`),a&&("function"==typeof app.load?app.load(n,r):location.href=e)}return o}function parseUrl(e){try{let t=new URL(e,location.href);return{hash:t.hash,search:t.search,path:t.pathname,isInlink:location.hostname==t.hostname}}catch(e){return{isInlink:!1,error:e}}}function imgurThumb(e,t="m"){let a=e.split("/").pop(),[o,n]=a.split(".");return"png"===n.toLowerCase()?e:`https://i.imgur.com/${o}${t}.${n}`}function markdown(e,t){return e.replace(REGEX.annotation,((e,t,a)=>(html_annotation+=`<p id="anno_${t}"><a href="#sup_${t}">[${t}]</a> ${a}</p>`,`<a href="#anno_${t}"><sup title="${a}" id="sup_${t}">[${t}]</sup></a>`))).replace(REGEX.colspan,((e,a)=>(t.dataset.colspan=a,""))).replace(REGEX.rowspan,((e,a)=>(t.dataset.rowspan=a,""))).replace(REGEX.css,((e,t,a)=>`<span style="${t}"/>${a}</span>`)).replace(REGEX.image,((e,t)=>`<img src="${t}"/>`)).replace(REGEX.link,((e,t)=>{let[a,o]=t.split(";");return`<a class="link" href="${a.startsWith("http")?a:"//"+a}" target="_blank">${o||"링크"}</a>`})).replace(REGEX.video,((e,t)=>`<iframe width="560" height="315" src="//www.youtube.com/embed/${getYoutubeId(t)}" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>`))}function focusSearch(){"undefined"!=typeof search_wrap&&search_wrap?.scrollIntoViewIfNeeded(),"undefined"!=typeof search__input&&search__input?.focus({preventScroll:!0})}async function uploadByImgur(e){loading(0);let t=new FormData;t.append("image",e),loading(.1);const a=await fetch("https://api.imgur.com/3/image",{method:"POST",headers:{Authorization:"Client-ID cfb9241edbf292e",Accept:"application/json"},body:t});loading(.7);let o=await a.json();return loading(.9),200===o.status&&firebase.resources.regist(o.data).catch(dev.error),loading(1),o}async function deleteImgurImg(e,t,a){const o=await fetch(`https://api.imgur.com/3/image/${t}`,{method:"DELETE",headers:{Authorization:"Client-ID cfb9241edbf292e",Accept:"application/json"}});let n=await o.json();return 200===n.status&&firebase.resources.delete(e,t,a).catch(dev.error),n}function getYoutubeId(e){const t=e.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/);return t&&11===t[2].length?t[2]:null}function loading(e){}function goShare(e,t=location.href){if(null==e&&"function"==typeof navigator.share)navigator.share({title:document.title,text:document.title,url:t});else{let a=new URLSearchParams;if("twitter"===e)a.set("url",t),a.set("text",`${document.title}\n#NEMUWIKI #네무위키\n`),window.open(`https://twitter.com/intent/tweet?${a.toString()}`,"_blank").focus()}}function modal(e="emailPrompt",t,a){let o=createElement("dialog"),n=createElement("form").attrs({method:"dialog"}),r=createElement("button").props({value:"cancel"}).attrs({class:"button secondary"}).props({innerHTML:TEXTS.form.cancel});document.body.append(o),o.append(n),n.append(MODAL_TEMPLATE[e](o,t,a)),n.append(r),o.showModal(),o.onclose=()=>o.remove()}function loadStyle(e){document.querySelectorAll(`link[href*="${e}"]`).length>0||document.head.append(createElement("link").attrs({rel:"stylesheet",href:`./css/${e}.css?_v=${version}`}))}HTMLElement.prototype.scrollIntoViewIfNeeded=function(){this.scrollIntoView({behavior:"smooth",block:"center",inline:"center"})},HTMLElement.prototype.css=function(e){if("object"==typeof e)for(let t in e)this.style[t]=e[t];return this},HTMLElement.prototype.attrs=function(e){if("object"==typeof e)for(let t in e)this.setAttribute(t,e[t]);return this},HTMLElement.prototype.props=function(e){if("object"==typeof e)for(let t in e)this[t]=e[t];return this},HTMLElement.prototype.addClass=function(){return this.classList.add.apply(this.classList,arguments),this},HTMLElement.prototype.removeClass=function(e){return this.classList.remove(e),this},HTMLElement.prototype.toggleClass=function(e,t){return this.classList.toggle(e,t),this},HTMLElement.prototype.prev=function(e){for(var t=this.previousElementSibling;null!=t;){if(Element.prototype.matches.call(t,e))return t;t=t.previousElementSibling}return null},HTMLElement.prototype.next=function(e){for(var t=this.nextElementSibling;null!=t;){if(Element.prototype.matches.call(t,e))return t;t=t.nextElementSibling}return null};const TEXTS={sitename:"네무위키",search_i:"검색창",recent_document:"최근 문서",document_cate:"문서 분류",upload:"글쓰기",mypage:"마이페이지",welcome_title:"네무위키:대문",search_result_title:"검색결과",edit:"수정",share:"공유",delete:"삭제",all_document:"전체 문서",character_document:"인물 문서",title:"제목",load_more:"load more",site_index:"대문",site_form:"문서 편찬",site_profile:"사용자 문서",zoomin:"+",zoomout:"-",warn:{login_already:"이미 로그인되어 있습니다.",login_neccesary:"로그인이 필요합니다",email_pattern:"이메일 형식에 맞지 않습니다.",password_short:"비밀번호는 8자 이상으로 입력하셔야 합니다.",password_mismatch:"비밀번호 재입력이 일치하지 않습니다.",beforeunload:"저장하지 않고 페이지를 나가시겠습니까?"},alert:{signup:"회원 가입완료 되었습니다.",login:"로그인이 완료 되었습니다.",logout:"로그아웃이 완료 되었습니다."},form:{login:"로그인",profile:"프로필",signup:"회원가입",find:"비밀번호 찾기",id:"이메일",pw:"비밀번호",re:"비밀번호 다시입력",cancel:"취소",apply:"적용"},empty:" "};let __CallStack__={categories:[],board:[]};const footer=createElement("footer").attrs({class:"content fold-end"}).props({innerHTML:"이 저작물은 CC BY-NC-SA 2.0 KR에 따라 이용할 수 있습니다. (단, 라이선스가 명시된 일부 문서 및 삽화 포함)<br>기여하신 문서의 저작권은 각 기여자에게 있으며, 각 기여자는 기여하신 부분의 저작권을 갖습니다.<br><br>네무위키는 백과사전이 아니며 검증되지 않았거나, 편향적이거나, 잘못된 서술이 있을 수 있습니다.<br>네무위키는 위키위키입니다. 여러분이 직접 문서를 고칠 수 있으며, 다른 사람의 의견을 원할 경우 직접 토론을 발제할 수 있습니다.<br>"}),FINAL={PERMISSION:{R:0,RW:1,RWD:2}};let Options={board:[],categories:[],get(e){switch(e){case"board":return Options.board.map((e=>({...e,value:e.name,path:getBoardPath(e),owner:e.owner}))).sort(((e,t)=>e.path.localeCompare(t.path)));case"categories":return Options.categories.map((e=>({...e,value:e.name,is_owner:e.owner==app.user?.uid}))).sort((e=>e.value))}}},Listerners={},app={},app_aside={},app_article={},now={},devmode=!1;const DOMAIN="nemuwiki.com",OLD_ROOT_PATH="/wiki",ROOT_PATH="/",FILE_UPLOAD_METHOD=0,Notify={alert:e=>alert(e),confirm:e=>confirm(e),prompt:e=>prompt(e),error:e=>{console.error(e)},toast:(e,t=2300)=>{let a=createElement("n-toast").props({innerHTML:e}),o=setInterval((()=>{t<100?(clearInterval(o),a.removeClass("open"),setTimeout((()=>{a.remove()}),150)):a.dataset.time=Math.ceil(t/1e3),t-=100}),100);document.body.append(a),setTimeout((()=>{a.addClass("open")}),10)}},dev=console,REGEX={annotation:/\[\*(\S+)\s([^\[\]]+)\]/gi,link:/\[link\:([^\s\[\]]+)\]/gi,image:/\[image\:([^\s\[\]]+)\]/gi,image_for_exec:/\[image\:([^\s\[\]]+)\]/i,video:/\[video\:([^\s\[\]]+)\]/gi,music:/\[music\:([^\s\[\]]+)\]/gi,colspan:/\[colspan\:([^\s\[\]]+)\]/gi,rowspan:/\[rowspan\:([^\s\[\]]+)\]/gi,css:/%\{([^\s\{\}]+)\}([^\{\}]+)%/gi};let html_annotation="",theme_color=localStorage.getItem("theme_color");theme_color&&applyThemes(theme_color),window.onload=async function(){location.href.startsWith(location.origin+"/wiki")&&history.replaceState({},"",location.href.replace("/wiki","")),app=new Router,checkLogin(),await app.load(),listenBoard()},window.addEventListener("popstate",(function(){if(app.blockMode&&(app.blockMode=!Notify.confirm(TEXTS.warn.beforeunload)),app.blockMode)return history.pushState(null,null,window.location.href);app.load()})),window.addEventListener("click",(function(e){let t=e.target.closest("a");if(t&&!e.ctrlKey){let a=t.getAttribute("href");if(!a)return;if(a.startsWith("#"))return e.preventDefault(),document.querySelector(a)?.scrollIntoViewIfNeeded(),void history.pushState({},"",a);move(a)&&e.preventDefault()}})),window.addEventListener("beforeunload",(e=>{app.blockMode&&(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation())}));let keyboardStatus={};window.addEventListener("keydown",(e=>{keyboardStatus.shift=e.shiftKey,keyboardStatus.ctrl=e.shiftKey})),window.addEventListener("keyup",(e=>{keyboardStatus.shift=e.shiftKey,keyboardStatus.ctrl=e.ctrlKey})),window.addEventListener("blur",(()=>{keyboardStatus={}}));